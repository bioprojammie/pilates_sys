<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>皮拉提斯管理系統</title> <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        
        /* 畫布強制白色背景 */
        canvas { touch-action: none; display: block; width: 100%; height: 100%; cursor: crosshair; background-color: #ffffff; }
        .canvas-box { border: 2px dashed #cbd5e1; border-radius: 12px; overflow: hidden; position: relative; background: white; width: 100%; }
        
        /* 隱藏卷軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* UI 元件樣式 */
        .tag { display: inline-flex; align-items: center; background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin-right: 4px; margin-bottom: 4px; font-weight: bold; border: 1px solid #dbeafe; }
        .cal-card { background: white; border-left: 3px solid #6366f1; padding: 6px; margin-bottom: 6px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.8rem; cursor: pointer; transition: transform 0.1s; }
        .cal-card:active { transform: scale(0.98); background: #f5f3ff; }
        .sig-label { font-size: 0.7rem; color: #9ca3af; margin-top: 2px; text-align: right; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-gray-800 w-full">

    <nav class="bg-white shadow-sm z-20 flex-none h-16 flex items-center justify-between px-4">
        <div class="font-bold text-xl text-indigo-600 flex items-center gap-2 select-none">
            <i class="fa-solid fa-person-running"></i> Pilates Pro
        </div>
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
            <button onclick="switchTab('page-list')" id="nav-list" class="px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition">總表</button>
            <button onclick="switchTab('page-create')" id="nav-create" class="px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition">建檔</button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 w-full max-w-6xl mx-auto no-scrollbar pb-24">

        <div id="page-create" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm max-w-2xl mx-auto space-y-5">
                <h2 class="text-lg font-bold border-b pb-2 text-gray-700">建立學生檔案</h2>
                
                <input type="text" id="cName" placeholder="學生姓名" class="w-full p-4 border rounded-xl bg-gray-50 text-lg focus:bg-white transition">
                <input type="number" id="cCredits" placeholder="初始堂數" class="w-full p-4 border rounded-xl bg-gray-50 text-lg focus:bg-white transition">
                <input type="text" id="cBody" placeholder="身體狀況備註" class="w-full p-4 border border-red-100 bg-red-50 text-red-600 rounded-xl focus:bg-white transition">
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <label class="font-bold text-blue-600 text-xs block mb-2">預設固定上課時間</label>
                    <div class="flex gap-2 mb-2 items-center">
                        <select id="schDay" class="p-3 rounded-lg border bg-white flex-1 font-bold text-gray-700">
                            <option value="週一">週一</option><option value="週二">週二</option><option value="週三">週三</option>
                            <option value="週四">週四</option><option value="週五">週五</option><option value="週六">週六</option><option value="週日">週日</option>
                        </select>
                        <select id="schHour" class="p-3 rounded-lg border bg-white font-mono font-bold"><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option></select>
                        <span class="font-bold text-gray-400">:</span>
                        <select id="schMin" class="p-3 rounded-lg border bg-white font-mono font-bold"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select>
                        <button onclick="addScheduleTag()" class="bg-blue-600 text-white px-4 py-3 rounded-lg font-bold">加入</button>
                    </div>
                    <div id="scheduleTags" class="min-h-[30px] flex flex-wrap"></div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <label class="font-bold text-indigo-600 text-xs block mb-2">1. 上傳合約 (照片/截圖)</label>
                    <input type="file" id="cContractFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-200 file:text-indigo-800 hover:file:bg-indigo-300 cursor-pointer">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <div class="flex justify-between mb-1"><label class="font-bold text-gray-400 text-xs">2. 學生簽名 (Student)</label><button onclick="clearPad('padNewContractStudent')" class="text-xs text-red-400">清除</button></div>
                        <div class="canvas-box h-32"><canvas id="padNewContractStudent"></canvas></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <div class="flex justify-between mb-1"><label class="font-bold text-gray-400 text-xs">3. 老師/甲方簽名 (Teacher)</label><button onclick="clearPad('padNewContractTeacher')" class="text-xs text-red-400">清除</button></div>
                        <div class="canvas-box h-32"><canvas id="padNewContractTeacher"></canvas></div>
                    </div>
                </div>

                <button onclick="createStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 active:scale-95 transition">完成建檔</button>
            </div>
        </div>

        <div id="page-list" class="">
            <div class="bg-white rounded-2xl shadow-sm mb-6 overflow-hidden border border-gray-100">
                <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <h3 class="font-bold text-indigo-800"><i class="fa-regular fa-calendar-days"></i> 本週課表總覽</h3>
                </div>
                <div class="overflow-x-auto pb-2">
                    <div class="grid grid-cols-7 min-w-[800px] divide-x divide-gray-100 text-center" id="calendarGrid"></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-h-[50vh]">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-500 text-sm uppercase">
                        <tr>
                            <th class="p-4 w-1/4">姓名</th>
                            <th class="p-4 w-1/3">固定時間</th>
                            <th class="p-4">剩餘堂數</th>
                            <th class="p-4 text-right">操作</th>
                        </tr>
                    </thead>
                    <tbody id="studentListBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            
            <div class="text-center mt-8 pb-8 flex flex-col items-center gap-2">
                 <button onclick="clearAllSystem()" class="text-xs text-gray-400 underline p-2 hover:text-red-500">重置所有系統資料</button>
                 <span class="text-[10px] text-gray-300">v7.9</span>
            </div>
        </div>

        <div id="page-detail" class="hidden">
            <button onclick="switchTab('page-list')" class="text-gray-500 font-bold flex items-center gap-1 bg-white px-3 py-2 rounded-lg shadow-sm mb-4 hover:bg-gray-100 w-fit"><i class="fa-solid fa-chevron-left"></i> 返回總表</button>
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-1">
                        <h2 id="dName" class="text-3xl font-bold text-gray-800"></h2>
                        <button onclick="viewContract()" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">查看合約</button>
                    </div>
                    <div id="dSchedule" class="flex flex-wrap gap-1 mt-1"></div>
                    <p id="dBody" class="text-xs text-red-500 font-bold mt-2 bg-red-50 inline-block px-2 py-1 rounded border border-red-100"></p>
                </div>
                <div class="bg-indigo-600 rounded-xl p-4 text-white shadow-md flex items-center gap-6 min-w-[200px] justify-between w-full md:w-auto">
                    <div>
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider">剩餘堂數</p>
                        <p id="dCredits" class="text-4xl font-mono font-bold leading-none">0</p>
                    </div>
                    <button onclick="openRenewModal()" class="bg-white text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-50 transition active:scale-95 whitespace-nowrap">
                        <i class="fa-solid fa-plus"></i> 購課/續約
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-5 space-y-5">
                    <div id="editor" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b">
                            <span id="editStatus" class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-500">新課程</span>
                            <button onclick="resetEditor()" class="text-xs text-indigo-500 font-bold hover:underline">＋ 新增一堂</button>
                        </div>
                        <div class="space-y-3 mb-6">
                            <div class="relative group">
                                <div id="imgPlaceholder" class="h-40 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-100" onclick="document.getElementById('fileInput').click()">
                                    <i class="fa-solid fa-camera text-2xl mb-1"></i><span class="text-xs font-bold">上傳課綱</span>
                                </div>
                                <img id="editImg" class="hidden w-full h-40 object-cover rounded-xl border border-gray-200 bg-white cursor-pointer" onclick="openPaintModal()">
                                <button id="btnPaint" onclick="openPaintModal()" class="hidden absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs font-bold backdrop-blur-md shadow">畫重點</button>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this)">
                            <textarea id="editNote" rows="2" placeholder="輸入文字備註..." class="w-full p-3 rounded-xl bg-gray-50 text-sm border-0 focus:ring-2 focus:ring-indigo-200"></textarea>
                            <button onclick="savePlan()" class="w-full py-2 border border-indigo-200 text-indigo-600 rounded-xl text-sm font-bold hover:bg-indigo-50">暫存為預排</button>
                        </div>
                        <div class="space-y-3 pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-end">
                                <label class="text-xs font-bold text-gray-400 uppercase">學生簽名確認</label>
                                <button onclick="clearPad('padCheckin')" class="text-xs text-red-400 px-2 hover:bg-red-50 rounded">清除</button>
                            </div>
                            <div class="canvas-box h-24 bg-gray-50"><canvas id="padCheckin"></canvas></div>
                            <button id="btnConfirm" onclick="confirmClass()" class="w-full bg-gray-200 text-gray-400 py-3 rounded-xl font-bold text-lg shadow-sm transition-all cursor-not-allowed" disabled>確認扣課</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-7">
                    <div class="bg-white p-6 rounded-2xl shadow-sm h-full min-h-[400px]">
                        <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider mb-4">歷史紀錄 Timeline</h3>
                        <div id="timeline" class="space-y-4 pb-20"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="renewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-lg p-6 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-200" id="renewContent">
            <h3 class="text-xl font-bold mb-4 text-center">購買 / 續約</h3>
            <div class="space-y-4">
                <input type="number" id="renewAmount" class="w-full p-4 border rounded-2xl text-2xl font-bold text-center outline-none focus:ring-2 focus:ring-indigo-500" placeholder="輸入堂數">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 p-2 rounded-xl border">
                        <div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">學生簽名</label><button onclick="clearPad('padRenewStudent')" class="text-xs text-red-400">清除</button></div>
                        <div class="canvas-box h-24 bg-white"><canvas id="padRenewStudent"></canvas></div>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-xl border">
                        <div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">老師簽名</label><button onclick="clearPad('padRenewTeacher')" class="text-xs text-red-400">清除</button></div>
                        <div class="canvas-box h-24 bg-white"><canvas id="padRenewTeacher"></canvas></div>
                    </div>
                </div>
                <div class="flex gap-3 mt-2"><button onclick="closeRenewModal()" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200">取消</button><button onclick="submitRenew()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700">確認購買</button></div>
            </div>
        </div>
    </div>

    <div id="paintModal" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col"><div class="flex justify-between items-center p-4 bg-gray-800 text-white safe-top"><button onclick="closePaintModal()" class="px-4 py-2 text-gray-300 font-bold hover:text-white">取消</button><h3 class="font-bold">圖片標註</h3><button onclick="savePaint()" class="px-4 py-2 bg-indigo-500 rounded-lg font-bold shadow hover:bg-indigo-600">完成</button></div><div class="flex-1 relative bg-black flex items-center justify-center overflow-hidden" id="paintContainer"><canvas id="canvasPaint" class="paint-canvas"></canvas></div><div class="p-6 bg-gray-800 flex justify-center gap-8 safe-bottom"><button onclick="setPen('#ef4444')" class="w-12 h-12 rounded-full bg-red-500 border-4 border-gray-700 ring-2 ring-white transition transform active:scale-90"></button><button onclick="setPen('#facc15')" class="w-12 h-12 rounded-full bg-yellow-400 border-4 border-gray-700 transition transform active:scale-90 opacity-80"></button><button onclick="setPen('#ffffff')" class="w-12 h-12 rounded-full bg-white border-4 border-gray-700 transition transform active:scale-90 opacity-80"></button></div></div>
    
    <div id="contractModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center p-4" onclick="this.classList.add('hidden')"><div class="bg-white p-4 rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">合約與簽名詳情</h3><button onclick="document.getElementById('contractModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button></div><div id="contractContent" class="space-y-4"></div></div></div>

    <script>
        let students = JSON.parse(localStorage.getItem('p79_st')) || [];
        let records = JSON.parse(localStorage.getItem('p79_rc')) || [];
        let curSid = null, editRecId = null;
        let tempSchedule = [];
        const pads = {};
        let paintBaseImg = null;

        function compressImage(src, maxWidth=1024, quality=0.7) { return new Promise((resolve) => { if(!src) resolve(null); const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height = Math.round((height *= maxWidth / width)); width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,width,height); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.src = src; }); }
        function fileToDataURL(file) { return new Promise((resolve) => { if(!file) resolve(null); const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.readAsDataURL(file); }); }
        function getTimeString() { return new Date().toLocaleString('zh-TW', { hour12: false }); }

        function initPad(id, isSig=false) {
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const parent = canvas.parentElement;
            if(parent.offsetWidth === 0) return;
            const resize = () => {
                if(parent.clientWidth === 0) return;
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = parent.clientWidth * ratio;
                canvas.height = parent.clientHeight * ratio;
                canvas.style.width = parent.clientWidth + "px";
                canvas.style.height = parent.clientHeight + "px";
                const ctx = canvas.getContext('2d');
                ctx.scale(ratio, ratio);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                if(id !== 'canvasPaint') {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width/ratio, canvas.height/ratio);
                }

                if(id === 'canvasPaint' && paintBaseImg) drawImageFit(paintBaseImg, canvas, ctx, parent.clientWidth, parent.clientHeight);
                
                if(id === 'padCheckin' && editRecId) {
                    const r = records.find(x => x.id === editRecId);
                    if(r && r.sig) {
                        const img = new Image();
                        img.onload = () => ctx.drawImage(img, 0, 0, parent.clientWidth, parent.clientHeight);
                        img.src = r.sig;
                        updateCheckinBtn(true);
                    }
                }
            };
            new ResizeObserver(resize).observe(parent);
            resize();
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            const getPos = (e) => { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; };
            const start = (e) => { if(e.cancelable && e.type.includes('touch')) e.preventDefault(); isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); };
            const move = (e) => { if(!isDrawing) return; if(e.cancelable && e.type.includes('touch')) e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.strokeStyle = isSig ? '#1f2937' : (pads.color||'#ef4444'); ctx.lineWidth = isSig ? 2 : 4; ctx.stroke(); if(id==='padCheckin') updateCheckinBtn(true); };
            const end = () => isDrawing=false;
            canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseout', end);
            pads[id] = {c: canvas, ctx: ctx};
        }

        function switchTab(id) {
            ['page-create', 'page-list', 'page-detail'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const navList = document.getElementById('nav-list');
            const navCreate = document.getElementById('nav-create');
            if(id === 'page-create') {
                navCreate.className = "px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition";
                navList.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition";
                requestAnimationFrame(() => { initPad('padNewContractStudent', true); initPad('padNewContractTeacher', true); });
            } else {
                navList.className = "px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition";
                navCreate.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition";
                if(id === 'page-list') renderList();
            }
        }

        function addScheduleTag() {
            const day = document.getElementById('schDay').value;
            const hour = document.getElementById('schHour').value;
            const min = document.getElementById('schMin').value;
            const tag = `${day} ${hour}:${min}`;
            if(!tempSchedule.includes(tag)) { tempSchedule.push(tag); renderTempTags(); }
        }
        function renderTempTags() { document.getElementById('scheduleTags').innerHTML = tempSchedule.map(t => `<span class="tag cursor-pointer hover:bg-red-100 hover:text-red-500" onclick="removeTag('${t}')">${t} <i class="fa-solid fa-xmark ml-1"></i></span>`).join(''); }
        function removeTag(t) { tempSchedule = tempSchedule.filter(x => x !== t); renderTempTags(); }

        // Create Student (Dual Sig)
        async function createStudent() {
            const name = document.getElementById('cName').value;
            const credits = document.getElementById('cCredits').value;
            const body = document.getElementById('cBody').value;
            const fileInput = document.getElementById('cContractFile');
            if(!name || !credits) return alert("請輸入完整資料");
            
            const sigStudent = await compressImage(pads['padNewContractStudent'].c.toDataURL(), 500, 0.5);
            const sigTeacher = await compressImage(pads['padNewContractTeacher'].c.toDataURL(), 500, 0.5);
            
            let contractImg = null;
            if(fileInput.files && fileInput.files[0]) {
                const rawBase64 = await fileToDataURL(fileInput.files[0]);
                contractImg = await compressImage(rawBase64, 1024, 0.7);
            }

            students.push({ 
                id: Date.now(), name, credits: parseInt(credits), body: body||"無", 
                contractSigStudent: sigStudent, contractSigTeacher: sigTeacher, 
                contractImg: contractImg, schedule: [...tempSchedule],
                contractDate: getTimeString()
            });
            save();
            document.getElementById('cName').value=''; document.getElementById('cCredits').value=''; fileInput.value = ''; tempSchedule = []; renderTempTags(); 
            clearPad('padNewContractStudent'); clearPad('padNewContractTeacher');
            switchTab('page-list');
        }

        function renderList() {
            const tbody = document.getElementById('studentListBody'); tbody.innerHTML = '';
            students.forEach(s => {
                const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50 active:bg-gray-100 transition cursor-pointer hover-effect"; tr.onclick = (e) => { if(e.target.closest('button')) return; openDetail(s.id); };
                const timeHtml = s.schedule && s.schedule.length > 0 ? s.schedule.map(t => `<span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mr-1 mb-1 font-bold">${t}</span>`).join('') : '<span class="text-xs text-gray-300">無</span>';
                tr.innerHTML = `<td class="p-4 font-bold text-gray-800 text-lg">${s.name}</td><td class="p-4 align-top">${timeHtml}</td><td class="p-4 font-mono font-bold text-xl ${s.credits<2?'text-red-500':'text-indigo-600'}">${s.credits}</td><td class="p-4 text-right"><button onclick="openDetail(${s.id})" class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-full shadow-sm hover:bg-indigo-100 transition flex items-center justify-center ml-auto"><i class="fa-solid fa-chevron-right"></i></button></td>`;
                tbody.appendChild(tr);
            });
            renderCalendar();
        }

        function renderCalendar() {
            const days = ['週一','週二','週三','週四','週五','週六','週日']; const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            days.forEach(day => {
                let classes = []; students.forEach(s => { if(s.schedule) s.schedule.forEach(timeStr => { if(timeStr.startsWith(day)) classes.push({ time: timeStr.split(' ')[1], name: s.name, sid: s.id }); }); });
                classes.sort((a,b) => a.time.localeCompare(b.time));
                const col = document.createElement('div'); col.className = "p-2 min-h-[150px]";
                let cardsHtml = classes.map(c => `<div class="cal-card" onclick="openDetail(${c.sid})"><div class="font-bold text-indigo-600">${c.time}</div><div class="truncate text-gray-700 font-bold">${c.name}</div></div>`).join('');
                if(classes.length === 0) cardsHtml = '<div class="text-xs text-gray-300 mt-4">-</div>';
                col.innerHTML = `<div class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide sticky top-0 bg-white py-1 z-10">${day}</div>${cardsHtml}`;
                grid.appendChild(col);
            });
        }

        function openDetail(sid) {
            try {
                curSid = sid; const s = students.find(x=>x.id===sid);
                document.getElementById('dName').innerText = s.name; document.getElementById('dCredits').innerText = s.credits; document.getElementById('dBody').innerText = s.body;
                document.getElementById('dSchedule').innerHTML = s.schedule && s.schedule.length ? s.schedule.map(t => `<span class="tag">${t}</span>`).join('') : '<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">未設定時間</span>';
                resetEditor(); renderTimeline(); switchTab('page-detail'); setTimeout(()=>initPad('padCheckin', true), 100);
            } catch(e) { console.error(e); }
        }

        function viewContract() {
            const s = students.find(x=>x.id===curSid); const c = document.getElementById('contractContent'); c.innerHTML = '';
            if(s.contractImg) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">合約照片:</p><img src="${s.contractImg}" class="w-full rounded border"></div>`;
            if(s.contractSigStudent) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">學生簽名:</p><img src="${s.contractSigStudent}" class="w-full rounded border bg-gray-50 h-24 object-contain"></div>`;
            if(s.contractSigTeacher) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">老師簽名:</p><img src="${s.contractSigTeacher}" class="w-full rounded border bg-gray-50 h-24 object-contain"></div>`;
            if(s.contractDate) c.innerHTML += `<div class="text-right text-xs text-gray-400 mt-2">簽署日期: ${s.contractDate}</div>`;
            document.getElementById('contractModal').classList.remove('hidden');
        }

        function openRenewModal() { 
            const m = document.getElementById('renewModal'); m.classList.remove('hidden'); 
            setTimeout(() => { m.classList.remove('opacity-0'); document.getElementById('renewContent').classList.remove('scale-95'); }, 10); 
            setTimeout(() => { initPad('padRenewStudent', true); initPad('padRenewTeacher', true); }, 100); 
        }
        function closeRenewModal() { const m = document.getElementById('renewModal'); m.classList.add('opacity-0'); document.getElementById('renewContent').classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }
        
        async function submitRenew() {
            const amt = parseInt(document.getElementById('renewAmount').value); if(!amt) return alert("請輸入堂數");
            const sigStu = await compressImage(pads['padRenewStudent'].c.toDataURL(), 500, 0.5);
            const sigTea = await compressImage(pads['padRenewTeacher'].c.toDataURL(), 500, 0.5);
            const time = getTimeString();
            
            const s = students.find(x=>x.id===curSid); s.credits += amt;
            records.unshift({ id: Date.now(), sid: curSid, date: time, type: 'renew', amount: amt, sigStudent: sigStu, sigTeacher: sigTea });
            save(); document.getElementById('dCredits').innerText = s.credits; document.getElementById('renewAmount').value = ''; 
            clearPad('padRenewStudent'); clearPad('padRenewTeacher');
            closeRenewModal(); renderTimeline();
        }

        function resetEditor(){editRecId=null;document.getElementById('editStatus').innerText="新課程";document.getElementById('editNote').value='';document.getElementById('editImg').classList.add('hidden');document.getElementById('imgPlaceholder').classList.remove('hidden');document.getElementById('btnPaint').classList.add('hidden');document.getElementById('fileInput').value='';clearPad('padCheckin');updateCheckinBtn(false)}
        function handleFile(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=(e)=>{const img=document.getElementById('editImg');img.src=e.target.result;img.classList.remove('hidden');document.getElementById('imgPlaceholder').classList.add('hidden');document.getElementById('btnPaint').classList.remove('hidden')};r.readAsDataURL(i.files[0])}}
        function openPaintModal(){const src=document.getElementById('editImg').src;if(!src)return;document.getElementById('paintModal').classList.remove('hidden');paintBaseImg=new Image();paintBaseImg.onload=()=>initPad('canvasPaint');paintBaseImg.src=src}
        function drawImageFit(img,c,ctx,cw,ch){const r=Math.min(cw/img.width,ch/img.height),w=img.width*r,h=img.height*r,x=(cw-w)/2,y=(ch-h)/2;ctx.clearRect(0,0,cw,ch);ctx.drawImage(img,0,0,img.width,img.height,x,y,w,h)}
        function setPen(c){pads.color=c}
        async function savePaint(){const d=await compressImage(pads['canvasPaint'].c.toDataURL(),1024,0.7);document.getElementById('editImg').src=d;closePaintModal()}
        function closePaintModal(){document.getElementById('paintModal').classList.add('hidden')}
        function updateCheckinBtn(a){const b=document.getElementById('btnConfirm');if(a){b.disabled=false;b.classList.remove('bg-gray-200','text-gray-400','cursor-not-allowed');b.classList.add('bg-green-600','text-white','shadow-lg');b.innerText=editRecId?"更新簽到":"確認扣課 (-1)"}else{b.disabled=true;b.classList.add('bg-gray-200','text-gray-400','cursor-not-allowed');b.classList.remove('bg-green-600','text-white','shadow-lg')}}
        async function savePlan(){await saveRecord('planned')}
        async function confirmClass(){if(confirm("確認扣課？"))await saveRecord('done')}
        
        async function saveRecord(status){
            const note=document.getElementById('editNote').value;
            const imgSrc=!document.getElementById('editImg').classList.contains('hidden')?document.getElementById('editImg').src:null;
            const finalImg=imgSrc?await compressImage(imgSrc):null;
            const finalSig=await compressImage(pads['padCheckin'].c.toDataURL(), 400, 0.5);
            const time = getTimeString();

            const s=students.find(x=>x.id===curSid);
            if(editRecId){
                const idx=records.findIndex(r=>r.id===editRecId);
                if(status==='done'&&records[idx].status==='planned') s.credits--;
                records[idx]={...records[idx], date: time, note, img: finalImg, sig: finalSig, status};
            }else{
                if(status==='done') s.credits--;
                records.unshift({id:Date.now(), sid:curSid, date: time, type:'class', status, note, img:finalImg, sig:finalSig});
            }
            save(); document.getElementById('dCredits').innerText=s.credits; renderTimeline(); resetEditor(); alert(status==='done'?"簽到成功":"預排已存");
        }

        function renderTimeline(){
            const t=document.getElementById('timeline'), my=records.filter(r=>r.sid===curSid); t.innerHTML=my.length?'':'<p class="text-center text-gray-300 py-6">尚無紀錄</p>';
            my.forEach(r=>{
                const d=document.createElement('div');
                if(r.type==='renew'){
                    d.className="bg-indigo-50 border border-indigo-100 p-4 rounded-2xl mb-4";
                    d.innerHTML=`<div class="flex justify-between font-bold text-indigo-800"><span><i class="fa-solid fa-receipt"></i> 購買紀錄</span><span>+${r.amount}</span></div><div class="flex gap-2 mt-2"><div class="flex-1"><img src="${r.sigStudent}" class="h-10 border bg-white rounded"><div class="sig-label">學生簽名</div></div><div class="flex-1"><img src="${r.sigTeacher}" class="h-10 border bg-white rounded"><div class="sig-label">老師簽名</div></div></div><div class="text-right text-xs text-indigo-400 mt-1">${r.date}</div>`;
                }else{
                    const done=r.status==='done';
                    d.className=`p-4 rounded-2xl mb-4 border-l-4 cursor-pointer shadow-sm hover:shadow-md transition ${done?'bg-white border-green-500':'bg-yellow-50 border-yellow-400'}`;
                    d.onclick=()=>loadEdit(r.id);
                    d.innerHTML=`<div class="flex justify-between mb-2"><span class="text-xs font-bold px-2 py-0.5 rounded ${done?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${done?'已完成':'預排'}</span><span class="text-xs text-gray-400">${r.date}</span></div><div class="flex gap-3">${r.img?`<img src="${r.img}" class="w-16 h-16 rounded-lg object-cover bg-gray-100 border">`:''}<div class="flex-1"><p class="text-sm text-gray-700 line-clamp-2">${r.note||'無備註'}</p>${r.sig?`<div class="mt-2 text-right border-t pt-1 flex justify-end items-center gap-2"><span class="text-[10px] text-gray-300">簽到時間: ${r.date}</span><img src="${r.sig}" class="h-6 bg-white border rounded"></div>`:''}</div></div>`;
                }
                t.appendChild(d);
            });
        }
        function loadEdit(rid){const r=records.find(x=>x.id===rid);if(r.type==='renew')return;editRecId=rid;document.getElementById('editStatus').innerText=r.status==='done'?"編輯紀錄":"編輯預排";document.getElementById('editNote').value=r.note||'';if(r.img){document.getElementById('editImg').src=r.img;document.getElementById('editImg').classList.remove('hidden');document.getElementById('imgPlaceholder').classList.add('hidden');document.getElementById('btnPaint').classList.remove('hidden')}document.getElementById('editor').scrollIntoView({behavior:'smooth'})}
        function clearPad(id){const p=pads[id];if(!p)return;p.ctx.clearRect(0,0,p.c.width,p.c.height);if(id!=='canvasPaint'){p.ctx.fillStyle='#ffffff';p.ctx.fillRect(0,0,p.c.width,p.c.height);}if(id==='padCheckin')updateCheckinBtn(false)}
        function save(){localStorage.setItem('p79_st',JSON.stringify(students));localStorage.setItem('p79_rc',JSON.stringify(records))}
        function clearAllSystem(){if(confirm("警告：清除後資料無法復原")){localStorage.clear();location.reload()}}
        switchTab('page-list');
    </script>
</body>
</html>
