<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="1on1 Pro">
    <title>1on1 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        /* V10.7: Canvas åŸºç¤è¨­å®šï¼Œä¸å¼·åˆ¶ 100% é¿å…é›™å±¤ç•«å¸ƒå®šä½è·‘æ‰ */
        canvas { touch-action: none; display: block; cursor: crosshair; }
        .canvas-box { border: 2px dashed #cbd5e1; border-radius: 12px; overflow: hidden; position: relative; background: white; width: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tag { display: inline-flex; align-items: center; background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin-right: 4px; margin-bottom: 4px; font-weight: bold; border: 1px solid #dbeafe; }
        .record-card { transition: all 0.2s; border-left: 5px solid transparent; }
        .record-card:active { transform: scale(0.99); }
        .record-card.status-planned { border-left-color: #fbbf24; background: white; }
        .record-card.status-done { border-left-color: #22c55e; background: #f0fdf4; }
        .img-thumb { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; flex-shrink: 0; background: white; }
        .img-scroller { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
        .cal-card { background: white; border-left: 3px solid #6366f1; padding: 6px; margin-bottom: 6px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.8rem; cursor: pointer; transition: transform 0.1s; }
        .sig-box { border: 2px dashed #cbd5e1; border-radius: 12px; height: 100%; min-height: 100px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: white; transition: all 0.2s; }
        .sig-box:active { background: #f8fafc; border-color: #94a3b8; }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        .toggle-label { width: 48px; height: 28px; background-color: #d1d5db; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s ease-in-out; }
        .toggle-label:before { content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; border-radius: 50%; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.3s ease-in-out; }
        .guide-content h4 { font-weight: bold; color: #4f46e5; margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .guide-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .guide-content li { margin-bottom: 0.5rem; }
        .guide-content p { margin-bottom: 1rem; }
        .guide-content blockquote { border-left: 4px solid #fbbf24; background-color: #fffbeb; padding: 1rem; margin: 1rem 0; font-style: italic; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-gray-800 w-full">

    <nav class="bg-white shadow-sm z-20 flex-none h-16 flex items-center justify-between px-4">
        <div class="font-bold text-xl text-indigo-600 flex items-center gap-2 select-none"><i class="fa-solid fa-user-check"></i> 1on1 Pro</div>
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
            <button onclick="switchTab('page-list')" id="nav-list" class="px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition">ç¸½è¡¨</button>
            <button onclick="switchTab('page-create')" id="nav-create" class="px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition">å»ºæª”</button>
            <button onclick="switchTab('page-settings')" id="nav-settings" class="px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition relative">è¨­å®š<span id="backupAlert" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span></button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 w-full max-w-6xl mx-auto no-scrollbar pb-24">
        <div id="page-create" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm max-w-2xl mx-auto space-y-5">
                <h2 class="text-lg font-bold border-b pb-2 text-gray-700">å»ºç«‹å­¸ç”Ÿæª”æ¡ˆ</h2>
                <input type="text" id="cName" placeholder="å­¸ç”Ÿå§“å" class="w-full p-4 border rounded-xl bg-gray-50 text-lg">
                <input type="number" id="cCredits" placeholder="åˆå§‹å ‚æ•¸" class="w-full p-4 border rounded-xl bg-gray-50 text-lg">
                <input type="text" id="cBody" placeholder="ç‹€æ³å‚™è¨»" class="w-full p-4 border rounded-xl">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><label class="font-bold text-blue-600 text-xs block mb-2">é è¨­å›ºå®šä¸Šèª²æ™‚é–“</label><div class="flex gap-2 mb-2 items-center"><select id="schDay" class="p-3 rounded-lg border bg-white flex-1 font-bold text-gray-700"><option value="é€±ä¸€">é€±ä¸€</option><option value="é€±äºŒ">é€±äºŒ</option><option value="é€±ä¸‰">é€±ä¸‰</option><option value="é€±å››">é€±å››</option><option value="é€±äº”">é€±äº”</option><option value="é€±å…­">é€±å…­</option><option value="é€±æ—¥">é€±æ—¥</option></select><select id="schHour" class="p-3 rounded-lg border bg-white font-mono font-bold"><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option></select><select id="schMin" class="p-3 rounded-lg border bg-white font-mono font-bold"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select><button onclick="addScheduleTag()" class="bg-blue-600 text-white px-4 py-3 rounded-lg font-bold">åŠ å…¥</button></div><div id="scheduleTags" class="min-h-[30px] flex flex-wrap"></div></div>
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><label class="font-bold text-indigo-600 text-xs block mb-2">1. ä¸Šå‚³åˆç´„</label><input type="file" id="cContractFile" accept="image/*" class="w-full text-sm"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gray-50 p-4 rounded-xl border"><div class="flex justify-between mb-1"><label class="font-bold text-gray-400 text-xs">2. å­¸ç”Ÿç°½å</label><button onclick="clearPad('padNewContractStudent')" class="text-xs text-red-400">æ¸…é™¤</button></div><div class="canvas-box h-32"><canvas id="padNewContractStudent"></canvas></div></div><div class="bg-gray-50 p-4 rounded-xl border"><div class="flex justify-between mb-1"><label class="font-bold text-gray-400 text-xs">3. è€å¸«/æ•™ç·´ç°½å</label><button onclick="clearPad('padNewContractTeacher')" class="text-xs text-red-400">æ¸…é™¤</button></div><div class="canvas-box h-32"><canvas id="padNewContractTeacher"></canvas></div></div></div>
                <button onclick="createStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">å®Œæˆå»ºæª”</button>
            </div>
        </div>

        <div id="page-list" class="">
            <div class="bg-white rounded-2xl shadow-sm mb-6 overflow-hidden border border-gray-100"><div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center"><h3 class="font-bold text-indigo-800"><i class="fa-regular fa-calendar-days"></i> ä¸€é€±èª²è¡¨</h3></div><div class="overflow-x-auto pb-2"><div class="grid grid-cols-7 min-w-[800px] divide-x divide-gray-100 text-center" id="calendarGrid"></div></div></div>
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-h-[40vh] mb-6"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-500 text-sm uppercase"><tr><th class="p-4 w-1/4">å§“å</th><th class="p-4 w-1/3">å›ºå®šæ™‚é–“</th><th class="p-4">å‰©é¤˜å ‚æ•¸</th><th class="p-4 text-right">æ“ä½œ</th></tr></thead><tbody id="studentListBody" class="divide-y divide-gray-100"></tbody></table></div>
            <div class="bg-gray-50 rounded-2xl border border-gray-200 overflow-hidden mb-6"><details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 text-gray-500 hover:bg-gray-100"><span class="flex items-center gap-2"><i class="fa-solid fa-box-archive"></i> å·²å°å­˜</span><span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span></summary><div class="text-gray-500 border-t border-gray-200 bg-white"><table class="w-full text-left border-collapse"><tbody id="archivedListBody" class="divide-y divide-gray-100"></tbody></table><div id="noArchiveMsg" class="p-4 text-center text-sm text-gray-300 hidden">æ²’æœ‰å°å­˜çš„å­¸ç”Ÿ</div></div></details></div>
        </div>

        <div id="page-detail" class="hidden">
            <button onclick="switchTab('page-list')" class="text-gray-500 font-bold flex items-center gap-1 bg-white px-3 py-2 rounded-lg shadow-sm mb-4 w-fit"><i class="fa-solid fa-chevron-left"></i> è¿”å›ç¸½è¡¨</button>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex-1"><div class="flex items-center gap-3 mb-1"><h2 id="dName" class="text-3xl font-bold text-gray-800"></h2><button onclick="openProfileModal()" class="text-gray-400 hover:text-indigo-600"><i class="fa-solid fa-gear fa-lg"></i></button><button onclick="viewContract()" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded ml-2">åˆç´„</button></div><div id="dSchedule" class="flex flex-wrap gap-1 mt-1"></div><p id="dBody" class="text-xs text-red-500 font-bold mt-2 bg-red-50 inline-block px-2 py-1 rounded border border-red-100"></p></div>
                <div class="bg-indigo-600 rounded-xl p-4 text-white shadow-md flex items-center gap-6 min-w-[200px] justify-between w-full md:w-auto"><div><p class="text-indigo-200 text-xs font-bold uppercase">å‰©é¤˜å ‚æ•¸</p><p id="dCredits" class="text-4xl font-mono font-bold leading-none">0</p></div><button onclick="openRenewModal()" class="bg-white text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-50 transition active:scale-95 whitespace-nowrap"><i class="fa-solid fa-plus"></i> è³¼èª²/çºŒç´„</button></div>
            </div>
            <div class="max-w-4xl mx-auto"><button onclick="addNewRecord()" class="w-full bg-white border-2 border-dashed border-indigo-200 text-indigo-600 py-4 rounded-2xl font-bold text-lg hover:bg-indigo-50 transition mb-6 shadow-sm"><i class="fa-solid fa-plus-circle"></i> é æ’æ–°èª²ç¨‹</button><div id="timeline" class="space-y-4 pb-20"></div></div>
        </div>

        <div id="page-settings" class="hidden">
            <div class="max-w-2xl mx-auto space-y-6 pt-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-700 mb-4"><i class="fa-solid fa-cloud-arrow-down text-indigo-500 mr-2"></i> å‚™ä»½èˆ‡é‚„åŸ</h3>
                    <p id="lastBackupText" class="text-sm text-gray-500 mb-4">ä¸Šæ¬¡å‚™ä»½æ™‚é–“ï¼š<span class="text-orange-500">å°šç„¡ç´€éŒ„</span></p>
                    <div class="flex flex-col sm:flex-row gap-4"><button onclick="backupData()" class="flex-1 bg-indigo-50 text-indigo-600 px-4 py-3 rounded-xl font-bold border border-indigo-100 hover:bg-indigo-100 transition flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ</button><label class="flex-1 bg-white text-gray-600 px-4 py-3 rounded-xl font-bold border border-gray-300 hover:bg-gray-50 transition flex items-center justify-center gap-2 cursor-pointer"><i class="fa-solid fa-upload"></i> é‚„åŸè³‡æ–™ (è®€å–)<input type="file" id="importFile" accept=".json" class="hidden" onchange="restoreData(this)"></label></div>
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="document.getElementById('guideModal').classList.remove('hidden')" class="w-full text-center text-indigo-600 font-bold text-sm hover:underline flex items-center justify-center gap-2 py-2">
                            <i class="fa-solid fa-book-open"></i> æŸ¥çœ‹å®Œæ•´ä½¿ç”¨æ•™å­¸æŒ‡å—
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-700 mb-4"><i class="fa-solid fa-bell text-yellow-500 mr-2"></i> å‚™ä»½æé†’</h3>
                    <div class="flex items-center justify-between"><label class="text-sm text-gray-600 font-bold">å°ç´…é»æé†’é »ç‡</label><select id="backupFreq" class="p-2 border rounded-lg bg-gray-50 text-sm font-bold" onchange="saveSettings()"><option value="999">å¾ä¸æé†’</option><option value="7">æ¯é€±ä¸€æ¬¡</option><option value="14">æ¯å…©é€±ä¸€æ¬¡</option><option value="30">æ¯æœˆä¸€æ¬¡</option></select></div>
                </div>
                <div class="text-center pt-8 border-t border-gray-200"><button onclick="clearAllSystem()" class="text-xs text-red-300 hover:text-red-500 underline mb-4">é‡ç½®ç³»çµ±</button><p class="text-[10px] text-gray-300">1on1 Pro v10.7</p></div>
            </div>
        </div>
    </main>

    <div id="guideModal" class="fixed inset-0 z-50 bg-black bg-opacity-60 hidden flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <div class="bg-white w-full max-w-2xl p-6 rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="font-bold text-xl text-gray-800">ğŸ“˜ 1on1 Pro ä½¿ç”¨æ•™å­¸æŒ‡å—</h3><button onclick="document.getElementById('guideModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark fa-xl"></i></button></div>
            <div class="guide-content text-gray-700 leading-relaxed text-sm">
                <p>å°ˆç‚ºè‡ªç”±æ¥æ¡ˆè€å¸«è¨­è¨ˆçš„è¼•é‡ç´šæ•™å­¸åŠ©æ‰‹ã€‚é©ç”¨æ–¼ï¼šå¥èº«æ•™ç·´ã€ç‘œçˆ/çš®æ‹‰ææ–¯è€å¸«ã€æ¨‚å™¨å®¶æ•™ã€èªè¨€å°å¸«ã€æ²»ç™‚å¸«ç­‰ã€‚</p>
                <h4>ğŸš€ æ ¸å¿ƒåŠŸèƒ½ç‰¹è‰²</h4>
                <ul><li><strong>å®Œç¾è·¨è£ç½®é«”é©—</strong>ï¼šæ¨è–¦ä½¿ç”¨ iPad ä¸¦ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ï¼Œäº«å—å…¨è¢å¹•æµæš¢æ“ä½œã€‚</li><li><strong>é›™å‘é›»å­åˆç´„</strong>ï¼šæ”¯æ´å­¸ç”Ÿèˆ‡è€å¸«é›™æ–¹é›»å­ç°½åã€‚</li><li><strong>è¦–è¦ºåŒ–é€±æ›†</strong>ï¼šè‡ªå‹•å½™æ•´æ‰€æœ‰å­¸ç”Ÿçš„å›ºå®šä¸Šèª²æ™‚é–“ã€‚</li><li><strong>å¡ç‰‡å¼èª²ç¨‹ç®¡ç†</strong>ï¼šæ”¯æ´é æ’ã€å¤šåœ–ç´€éŒ„ï¼ˆå¯ç•«ç·šæ¨™è¨»ï¼‰ã€ç°½åˆ°æ‰£èª²ã€‚</li><li><strong>åœ–ç‰‡ç›´é€šè»Š</strong>ï¼šåœ¨èª²è¡¨å¡ç‰‡ä¸Šç›´æ¥é»æ“Šç…§ç‰‡ï¼Œå³å¯å¿«é€Ÿé€²å…¥ç¹ªåœ–æ¨¡å¼ï¼Œæ”¯æ´å¾©åŸèˆ‡æ©¡çš®æ“¦ã€‚</li><li><strong>è³‡æ–™ç®¡ç†</strong>ï¼šæ”¯æ´å­¸ç”Ÿå°å­˜èˆ‡è‡ªä¸»å‚™ä»½é‚„åŸã€‚</li></ul>
                <h4>ğŸ“² å®‰è£æ•™å­¸ (iOS/iPadOS æ¨è–¦)</h4>
                <ol class="list-decimal pl-6 mb-4"><li>ä½¿ç”¨ <strong>Safari ç€è¦½å™¨</strong> é–‹å•Ÿæœ¬ç³»çµ±ã€‚</li><li>é»æ“Šå³ä¸Šè§’çš„ <strong>ã€Œåˆ†äº«ã€</strong> æŒ‰éˆ• <i class="fa-solid fa-arrow-up-from-bracket"></i>ã€‚</li><li>å¾€ä¸‹æ»‘å‹•é¸å–®ï¼Œé»é¸ <strong>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€(Add to Home Screen)</strong>ã€‚</li><li>è¼¸å…¥åç¨±å¾ŒæŒ‰ä¸‹æ–°å¢ï¼Œå›åˆ°æ¡Œé¢é»æ“Š App åœ–ç¤ºå³å¯ä½¿ç”¨ã€‚</li></ol>
                <h4>âš ï¸ è³‡æ–™å®‰å…¨èˆ‡å‚™ä»½ (éå¸¸é‡è¦)</h4>
                <p>æœ¬ç³»çµ±æ¡ç”¨å–®æ©Ÿç¶²é æŠ€è¡“ï¼Œæ‰€æœ‰è³‡æ–™çš†å„²å­˜åœ¨æ‚¨ç›®å‰çš„è£ç½®ç€è¦½å™¨ä¸­ã€‚</p>
                <blockquote><strong>æˆ‘å€‘ä¸æœƒå°‡æ‚¨çš„è³‡æ–™ä¸Šå‚³è‡³ä»»ä½•é›²ç«¯ä¼ºæœå™¨ï¼Œé€™æ„å‘³è‘—åªæœ‰æ‚¨èƒ½çœ‹åˆ°é€™äº›è³‡æ–™ï¼Œä¿éšœçµ•å°éš±ç§ã€‚</strong></blockquote>
                <ul><li>âŒ <strong>è«‹å‹¿æ¸…é™¤ç€è¦½å™¨å¿«å– (Cache)</strong>ï¼šé€™æœƒå°è‡´è³‡æ–™éºå¤±ã€‚</li><li>ğŸ’¾ <strong>å®šæœŸå‚™ä»½</strong>ï¼šè«‹å®šæœŸè‡³è¨­å®šé é»æ“Šã€Œä¸‹è¼‰å‚™ä»½æª”æ¡ˆã€ï¼Œä¸¦å°‡æª”æ¡ˆå¦¥å–„ä¿å­˜ï¼ˆå»ºè­°å­˜æ–¼ iCloud Drive æˆ– Google Driveï¼‰ã€‚</li><li>ğŸ“± <strong>æ›´æ›è£ç½®</strong>ï¼šè‹¥éœ€æ›´æ›æ‰‹æ©Ÿæˆ–å¹³æ¿ï¼Œè«‹å…ˆåœ¨èˆŠæ©ŸåŸ·è¡Œå‚™ä»½ï¼Œå†æ–¼æ–°æ©ŸåŸ·è¡Œã€Œé‚„åŸè³‡æ–™ã€ã€‚</li></ul>
            </div>
            <button onclick="document.getElementById('guideModal').classList.add('hidden')" class="w-full mt-6 bg-indigo-600 text-white py-3 rounded-xl font-bold">æˆ‘ç­è§£äº†</button>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 z-50 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl relative overflow-hidden"><h3 class="font-bold text-xl mb-4 border-b pb-2">ç·¨è¼¯å­¸ç”Ÿè³‡æ–™</h3><div class="space-y-4 max-h-[70vh] overflow-y-auto pb-20 no-scrollbar"><div><label class="text-xs text-gray-500 font-bold">å§“å</label><input type="text" id="pName" class="w-full p-3 border rounded-xl bg-gray-50"></div><div><label class="text-xs text-gray-500 font-bold">ç‹€æ³å‚™è¨»</label><input type="text" id="pBody" class="w-full p-3 border rounded-xl bg-gray-50"></div><div class="bg-blue-50 p-3 rounded-xl border border-blue-100"><label class="text-xs font-bold text-blue-600 mb-2 block">å›ºå®šä¸Šèª²æ™‚é–“</label><div class="flex gap-1 mb-2"><select id="pDay" class="p-2 rounded border bg-white flex-1 text-sm"><option value="é€±ä¸€">é€±ä¸€</option><option value="é€±äºŒ">é€±äºŒ</option><option value="é€±ä¸‰">é€±ä¸‰</option><option value="é€±å››">é€±å››</option><option value="é€±äº”">é€±äº”</option><option value="é€±å…­">é€±å…­</option><option value="é€±æ—¥">é€±æ—¥</option></select><select id="pHour" class="p-2 rounded border bg-white text-sm font-mono"><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option></select><select id="pMin" class="p-2 rounded border bg-white text-sm font-mono"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select><button onclick="addProfileScheduleTag()" class="bg-blue-600 text-white px-3 rounded font-bold text-sm">ï¼‹</button></div><div id="profileScheduleTags" class="min-h-[30px] flex flex-wrap gap-1"></div></div><div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl border"><span class="font-bold text-gray-700">å­¸ç”Ÿç‹€æ…‹</span><div class="flex items-center gap-3"><span id="pArchivedStatus" class="text-xs font-bold text-green-600">æ´»èº</span><div class="relative inline-block w-12 h-7 align-middle select-none"><input type="checkbox" id="pArchivedToggle" class="toggle-checkbox absolute block w-0 h-0 opacity-0"/><label for="pArchivedToggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label></div></div></div></div><div class="flex gap-3 mt-6 pt-4 border-t bg-white"><button onclick="document.getElementById('profileModal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button><button onclick="saveProfile()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow">å„²å­˜è®Šæ›´</button></div><div class="text-center mt-4"><button onclick="deleteStudent()" class="text-xs text-red-400 hover:text-red-600 hover:underline"><i class="fa-solid fa-trash"></i> æ°¸ä¹…åˆªé™¤æ­¤å­¸ç”Ÿ</button></div></div></div>
    
    <div id="paintModal" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col">
        <div class="flex justify-between items-center p-4 bg-gray-800 text-white safe-top">
            <div class="flex gap-2"><button onclick="closePaintModal()" class="px-3 py-2 text-gray-300 font-bold hover:text-white">å–æ¶ˆ</button><button onclick="undoPaint()" class="px-3 py-2 bg-gray-700 rounded-lg font-bold hover:bg-gray-600"><i class="fa-solid fa-rotate-left"></i></button></div>
            <h3 class="font-bold">åœ–ç‰‡æ¨™è¨»</h3>
            <button onclick="savePaint()" class="px-4 py-2 bg-indigo-500 rounded-lg font-bold shadow hover:bg-indigo-600">å®Œæˆ</button>
        </div>
        <div class="flex-1 relative bg-black flex items-center justify-center overflow-hidden" id="paintContainer">
            <canvas id="canvasBg" class="absolute inset-0 pointer-events-none"></canvas> <canvas id="canvasPaint" class="absolute inset-0 z-10 cursor-crosshair"></canvas> </div>
        <div class="p-6 bg-gray-800 flex justify-center gap-4 safe-bottom overflow-x-auto">
            <button onclick="setPen('#ef4444')" class="w-12 h-12 rounded-full bg-red-500 border-4 border-gray-700 ring-2 ring-white transition hover:scale-110 flex-shrink-0" id="btn-red"></button>
            <button onclick="setPen('#facc15')" class="w-12 h-12 rounded-full bg-yellow-400 border-4 border-gray-700 transition hover:scale-110 flex-shrink-0" id="btn-yellow"></button>
            <button onclick="setPen('#3b82f6')" class="w-12 h-12 rounded-full bg-blue-500 border-4 border-gray-700 transition hover:scale-110 flex-shrink-0" id="btn-blue"></button>
            <button onclick="setPen('#22c55e')" class="w-12 h-12 rounded-full bg-green-500 border-4 border-gray-700 transition hover:scale-110 flex-shrink-0" id="btn-green"></button>
            <div class="w-px h-12 bg-gray-600 mx-2"></div>
            <button onclick="setEraser()" class="w-12 h-12 rounded-full bg-gray-200 border-4 border-gray-700 text-gray-600 transition hover:scale-110 flex items-center justify-center flex-shrink-0" id="btn-eraser"><i class="fa-solid fa-eraser"></i></button>
        </div>
    </div>

    <div id="contentModal" class="fixed inset-0 z-40 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-lg p-5 rounded-2xl shadow-2xl h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg">ç·¨è¼¯èª²ç¨‹å…§å®¹</h3><button onclick="closeContentModal()" class="text-gray-400"><i class="fa-solid fa-xmark fa-xl"></i></button></div><div class="flex-1 overflow-y-auto space-y-4"><textarea id="modalEditNote" rows="5" placeholder="è¼¸å…¥èª²ç¨‹ç­†è¨˜..." class="w-full p-3 rounded-xl bg-gray-50 text-base border focus:ring-2 focus:ring-blue-200"></textarea><div class="font-bold text-gray-500 text-sm">ç…§ç‰‡ç´€éŒ„</div><div class="flex gap-2 overflow-x-auto pb-2 min-h-[110px]" id="modalImgList"></div><label class="block w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-center text-gray-400 font-bold cursor-pointer hover:bg-gray-50"><i class="fa-solid fa-images"></i> é»æ­¤ä¸Šå‚³ç…§ç‰‡<input type="file" id="modalFileInput" accept="image/*" multiple class="hidden" onchange="handleModalAddImage(this)"></label></div><div class="mt-4 pt-2 border-t"><button onclick="saveModalContent()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">å„²å­˜å…§å®¹</button></div></div></div>
    <div id="signModal" class="fixed inset-0 z-40 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md p-5 rounded-2xl shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">å­¸ç”Ÿç°½åˆ°</h3><button onclick="clearPad('padSignModal')" class="text-xs text-red-500 font-bold">æ¸…é™¤é‡ç°½</button></div><div class="canvas-box h-48 bg-gray-50 mb-4"><canvas id="padSignModal"></canvas></div><div class="flex gap-3"><button onclick="closeSignModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button><button onclick="confirmSignModal()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg">ç¢ºèª (æ‰£1å ‚)</button></div></div></div>
    <div id="renewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm"><div class="bg-white w-[90%] max-w-lg p-6 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-200" id="renewContent"><h3 class="text-xl font-bold mb-4 text-center">è³¼è²· / çºŒç´„</h3><div class="space-y-4"><input type="number" id="renewAmount" class="w-full p-4 border rounded-2xl text-2xl font-bold text-center outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥å ‚æ•¸"><div class="grid grid-cols-2 gap-3"><div class="bg-gray-50 p-2 rounded-xl border"><div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">å­¸ç”Ÿç°½å</label><button onclick="clearPad('padRenewStudent')" class="text-xs text-red-400">æ¸…é™¤</button></div><div class="canvas-box h-24 bg-white"><canvas id="padRenewStudent"></canvas></div></div><div class="bg-gray-50 p-2 rounded-xl border"><div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">è€å¸«ç°½å</label><button onclick="clearPad('padRenewTeacher')" class="text-xs text-red-400">æ¸…é™¤</button></div><div class="canvas-box h-24 bg-white"><canvas id="padRenewTeacher"></canvas></div></div></div><div class="flex gap-3 mt-2"><button onclick="closeRenewModal()" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200">å–æ¶ˆ</button><button onclick="submitRenew()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700">ç¢ºèªè³¼è²·</button></div></div></div></div>
    <div id="contractModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center p-4" onclick="this.classList.add('hidden')"><div class="bg-white p-4 rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">åˆç´„èˆ‡ç°½åè©³æƒ…</h3><button onclick="document.getElementById('contractModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button></div><div id="contractContent" class="space-y-4"></div></div></div>

    <script>
        const CUR_VER = 'tms_v6';
        const OLD_VER = 'tms_v5';

        function loadAndUpgradeData() {
            let st = localStorage.getItem(CUR_VER + '_st');
            let rc = localStorage.getItem(CUR_VER + '_rc');
            let settings = JSON.parse(localStorage.getItem(CUR_VER + '_set')) || { lastBackup: null, freq: '7' }; 
            if (st && rc) return { students: JSON.parse(st), records: JSON.parse(rc), settings };
            let oldSt = localStorage.getItem(OLD_VER + '_st') || localStorage.getItem('tms_v4_st');
            let oldRc = localStorage.getItem(OLD_VER + '_rc') || localStorage.getItem('tms_v4_rc');
            if (oldSt && oldRc) {
                console.log("Auto migrating data...");
                localStorage.setItem(CUR_VER + '_st', oldSt);
                localStorage.setItem(CUR_VER + '_rc', oldRc);
                localStorage.setItem(CUR_VER + '_set', JSON.stringify(settings));
                return { students: JSON.parse(oldSt), records: JSON.parse(oldRc), settings };
            }
            return { students: [], records: [], settings };
        }

        const data = loadAndUpgradeData();
        let students = data.students;
        let records = data.records;
        let appSettings = data.settings;
        
        let curSid = null, editRecId = null;
        let tempSchedule = [], tempProfileSchedule = [];
        let tempEditorImages = [];
        let paintImgIndex = -1;
        let isDirectEdit = false;
        let directEditRecId = null;
        let paintHistory = [];
        const pads = {};
        let bgCanvasCtx = null;

        // --- Core Functions ---
        function compressImage(src, maxWidth=800, quality=0.6) { return new Promise((resolve) => { if(!src) resolve(null); const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height = Math.round((height *= maxWidth / width)); width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,width,height); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.src = src; }); }
        function fileToDataURL(file) { return new Promise((resolve) => { if(!file) resolve(null); const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.readAsDataURL(file); }); }
        function getTimeString() { return new Date().toLocaleString('zh-TW', { hour12: false }); }

        function initPad(id, isSig=false) {
            const canvas = document.getElementById(id); if(!canvas) return; const parent = canvas.parentElement; if(parent.offsetWidth === 0) return;
            
            // V10.7: Canvas Sizing Logic
            const resize = () => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                const w = parent.clientWidth; const h = parent.clientHeight;
                canvas.width = w * ratio; canvas.height = h * ratio;
                canvas.style.width = w + "px"; canvas.style.height = h + "px";
                const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio); ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                
                if(id === 'canvasPaint') {
                    const bgC = document.getElementById('canvasBg');
                    if(bgC) { 
                        bgC.width = w * ratio; bgC.height = h * ratio;
                        bgCanvasCtx = bgC.getContext('2d'); bgCanvasCtx.scale(ratio, ratio);
                    }
                } else {
                    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width/ratio, canvas.height/ratio);
                }
            };
            
            new ResizeObserver(resize).observe(parent); resize();
            const ctx = canvas.getContext('2d'); let isDrawing = false;
            
            const saveHistory = () => { if(id === 'canvasPaint') { if(paintHistory.length > 10) paintHistory.shift(); paintHistory.push(canvas.toDataURL()); } };
            const getPos = (e) => { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; };
            const start = (e) => { if(e.cancelable && e.type.includes('touch')) e.preventDefault(); if(id === 'canvasPaint') saveHistory(); isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); };
            const move = (e) => { if(!isDrawing) return; if(e.cancelable && e.type.includes('touch')) e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x,p.y); if(id !== 'canvasPaint') { ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 2; } ctx.stroke(); };
            const end = () => isDrawing=false;
            canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseout', end);
            pads[id] = {c: canvas, ctx: ctx};
        }

        // --- Navigation ---
        function switchTab(id) {
            ['page-create', 'page-list', 'page-detail', 'page-settings'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            ['nav-create', 'nav-list', 'nav-settings'].forEach(n => { document.getElementById(n).className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition relative"; });
            document.getElementById(id.replace('page', 'nav')).className = "px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition relative";
            if(id === 'page-create') requestAnimationFrame(() => { initPad('padNewContractStudent', true); initPad('padNewContractTeacher', true); });
            if(id === 'page-list') renderList();
            if(id === 'page-settings') renderSettingsPage();
        }

        function renderSettingsPage() {
            document.getElementById('backupFreq').value = appSettings.freq;
            const lastBackupEl = document.getElementById('lastBackupText');
            lastBackupEl.innerHTML = appSettings.lastBackup ? `ä¸Šæ¬¡å‚™ä»½æ™‚é–“ï¼š<span class="text-indigo-600 font-mono">${appSettings.lastBackup.split('T')[0]}</span>` : `ä¸Šæ¬¡å‚™ä»½æ™‚é–“ï¼š<span class="text-orange-500">å°šç„¡ç´€éŒ„</span>`;
        }
        function saveSettings() { appSettings.freq = document.getElementById('backupFreq').value; save(); checkBackupStatus(); }
        function checkBackupStatus() {
            const dot = document.getElementById('backupAlert');
            if (appSettings.freq === '999') { dot.classList.add('hidden'); return; }
            if (!appSettings.lastBackup) { dot.classList.remove('hidden'); return; }
            const diffDays = (new Date() - new Date(appSettings.lastBackup)) / (1000 * 60 * 60 * 24);
            diffDays > parseInt(appSettings.freq) ? dot.classList.remove('hidden') : dot.classList.add('hidden');
        }
        checkBackupStatus();

        // --- Application Functions ---
        function addScheduleTag() { const day=document.getElementById('schDay').value, hour=document.getElementById('schHour').value, min=document.getElementById('schMin').value, tag=`${day} ${hour}:${min}`; if(!tempSchedule.includes(tag)){tempSchedule.push(tag); renderTempTags();} }
        function renderTempTags() { document.getElementById('scheduleTags').innerHTML = tempSchedule.map(t => `<span class="tag cursor-pointer hover:bg-red-100 hover:text-red-500" onclick="removeTag('${t}')">${t} <i class="fa-solid fa-xmark ml-1"></i></span>`).join(''); }
        function removeTag(t) { tempSchedule = tempSchedule.filter(x => x !== t); renderTempTags(); }
        
        const toggleCheck = document.getElementById('pArchivedToggle');
        const toggleLabel = document.getElementById('pArchivedStatus');
        toggleCheck.addEventListener('change', function() { toggleLabel.innerText = this.checked ? "æ´»èº" : "å°å­˜"; toggleLabel.className = this.checked ? "text-xs font-bold text-green-600" : "text-xs font-bold text-gray-400"; });

        function openProfileModal() { 
            const s = students.find(x => x.id === curSid); 
            document.getElementById('pName').value = s.name; document.getElementById('pBody').value = s.body; 
            toggleCheck.checked = !s.isArchived; toggleLabel.innerText = !s.isArchived ? "æ´»èº" : "å°å­˜"; toggleLabel.className = !s.isArchived ? "text-xs font-bold text-green-600" : "text-xs font-bold text-gray-400";
            tempProfileSchedule = [...(s.schedule || [])]; renderProfileTags(); 
            document.getElementById('profileModal').classList.remove('hidden'); 
        }
        function saveProfile() { 
            const idx = students.findIndex(x => x.id === curSid); 
            if(idx > -1) { 
                students[idx].name = document.getElementById('pName').value; students[idx].body = document.getElementById('pBody').value; students[idx].schedule = [...tempProfileSchedule]; students[idx].isArchived = !toggleCheck.checked;
                save(); !students[idx].isArchived ? openDetail(curSid) : switchTab('page-list'); document.getElementById('profileModal').classList.add('hidden');
            } 
        }
        function toggleArchiveFromList(sid) { const idx = students.findIndex(x => x.id === sid); if(idx > -1) { students[idx].isArchived = !students[idx].isArchived; save(); renderList(); } }
        function deleteStudent() { if(confirm("âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤è©²å­¸ç”ŸåŠå…¶æ‰€æœ‰èª²ç¨‹ç´€éŒ„ï¼Œç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šåˆªé™¤ï¼Ÿ")) { const idx = students.findIndex(x => x.id === curSid); if(idx > -1) { students.splice(idx, 1); records = records.filter(r => r.sid !== curSid); save(); document.getElementById('profileModal').classList.add('hidden'); switchTab('page-list'); } } }
        function addProfileScheduleTag() { const day=document.getElementById('pDay').value, hour=document.getElementById('pHour').value, min=document.getElementById('pMin').value, tag=`${day} ${hour}:${min}`; if(!tempProfileSchedule.includes(tag)){tempProfileSchedule.push(tag); renderProfileTags();} }
        function renderProfileTags() { document.getElementById('profileScheduleTags').innerHTML = tempProfileSchedule.map(t => `<span class="tag cursor-pointer hover:bg-red-100 hover:text-red-500" onclick="removeProfileTag('${t}')">${t} <i class="fa-solid fa-xmark ml-1"></i></span>`).join(''); }
        function removeProfileTag(t) { tempProfileSchedule = tempProfileSchedule.filter(x => x !== t); renderProfileTags(); }

        function backupData() { 
            const d = { students, records, settings: appSettings, version: "10.7", date: new Date().toISOString() }; 
            const b = new Blob([JSON.stringify(d)], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `1on1pro_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); 
            appSettings.lastBackup = new Date().toISOString(); save(); renderSettingsPage(); checkBackupStatus(); alert("å·²ä¸‹è¼‰å‚™ä»½æª”"); 
        }
        function restoreData(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); if (d.students && d.records && confirm("é‚„åŸå°‡è¦†è“‹ç›®å‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) { localStorage.setItem(CUR_VER + '_st', JSON.stringify(d.students)); localStorage.setItem(CUR_VER + '_rc', JSON.stringify(d.records)); if(d.settings) localStorage.setItem(CUR_VER + '_set', JSON.stringify(d.settings)); alert("é‚„åŸæˆåŠŸ"); location.reload(); } } catch (err) { alert("æª”æ¡ˆéŒ¯èª¤"); } }; r.readAsText(f); }
        function clearAllSystem() { if(confirm("æ¸…é™¤æ‰€æœ‰è³‡æ–™ç„¡æ³•å¾©åŸï¼Œç¢ºå®šï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        async function createStudent() {
            const name=document.getElementById('cName').value, credits=document.getElementById('cCredits').value, body=document.getElementById('cBody').value, fileInput=document.getElementById('cContractFile');
            if(!name || !credits) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            const sigStudent = await compressImage(pads['padNewContractStudent'].c.toDataURL(), 500, 0.5);
            const sigTeacher = await compressImage(pads['padNewContractTeacher'].c.toDataURL(), 500, 0.5);
            let contractImg = null; if(fileInput.files && fileInput.files[0]) { contractImg = await compressImage(await fileToDataURL(fileInput.files[0]), 1024, 0.7); }
            students.push({ id: Date.now(), name, credits: parseInt(credits), body: body||"ç„¡", contractSigStudent: sigStudent, contractSigTeacher: sigTeacher, contractImg: contractImg, schedule: [...tempSchedule], contractDate: getTimeString(), isArchived: false });
            save(); document.getElementById('cName').value=''; document.getElementById('cCredits').value=''; fileInput.value = ''; tempSchedule = []; renderTempTags(); clearPad('padNewContractStudent'); clearPad('padNewContractTeacher'); switchTab('page-list');
        }

        function addNewRecord() { const newRec = { id: Date.now(), sid: curSid, date: getTimeString(), type: 'class', status: 'planned', note: '', imgs: [], sig: null }; records.unshift(newRec); save(); renderTimeline(); }

        function renderTimeline() {
            const t = document.getElementById('timeline'); const my = records.filter(r => r.sid === curSid); t.innerHTML = my.length ? '' : '<p class="text-center text-gray-300 py-6">å°šç„¡èª²ç¨‹ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•é æ’</p>';
            my.forEach(r => {
                const div = document.createElement('div'); div.className = "record-card shadow-sm rounded-2xl mb-4 p-4 border border-gray-100 relative";
                if (r.type === 'renew') {
                    div.style.borderLeftColor = '#6366f1'; div.innerHTML = `<div class="flex justify-between font-bold text-indigo-800"><span><i class="fa-solid fa-receipt"></i> è³¼è²·ç´€éŒ„</span><span>+${r.amount}</span></div><div class="text-right text-xs text-indigo-400 mt-1">${r.date}</div>`;
                } else {
                    const isDone = r.status === 'done'; div.className += isDone ? " status-done" : " status-planned";
                    const metaHtml = `<div class="md:col-span-2 col-span-12 flex md:flex-col justify-between md:justify-start gap-2 border-b md:border-b-0 md:border-r border-gray-100 pb-2 md:pb-0 md:pr-4"><div><div class="font-bold text-gray-700">${r.date.split(' ')[0]}</div><div class="text-xs text-gray-400 mb-2">${r.date.split(' ')[1]}</div>${isDone ? '<span class="text-green-600 text-xs font-bold bg-green-100 px-2 py-1 rounded">å·²ç°½åˆ°</span>' : '<span class="text-yellow-600 text-xs font-bold bg-yellow-100 px-2 py-1 rounded">é æ’ä¸­</span>'}</div><button onclick="openContentModal(${r.id})" class="text-blue-500 bg-blue-50 px-3 py-2 rounded-xl text-sm font-bold hover:bg-blue-100 flex items-center justify-center gap-1"><i class="fa-solid fa-pen"></i> ç·¨è¼¯</button></div>`;
                    const imgsHtml = (r.imgs && r.imgs.length > 0) 
                        ? `<div class="img-scroller mt-2">${r.imgs.map((src, idx)=>`<img src="${src}" class="img-thumb flex-none" onclick="openDirectPaint(${r.id}, ${idx})">`).join('')}</div>` 
                        : `<div class="mt-2 text-xs text-gray-300 italic p-2 border border-dashed rounded text-center cursor-pointer" onclick="openContentModal(${r.id})">é»æ­¤æ–°å¢ç…§ç‰‡</div>`;
                    const contentHtml = `<div class="md:col-span-7 col-span-12 px-2 py-2 md:py-0"><p class="text-sm text-gray-700 whitespace-pre-wrap">${r.note || '<span class="text-gray-300">é»æ“Šç·¨è¼¯æŒ‰éˆ•æ–°å¢ç­†è¨˜...</span>'}</p>${imgsHtml}</div>`;
                    let actionHtml = isDone ? `<div class="md:col-span-3 col-span-12 flex flex-col items-center justify-center border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-4"><img src="${r.sig}" class="h-16 object-contain"><span class="text-[10px] text-green-600 font-bold mt-1">âœ“ å·²æ‰£èª²ç¢ºèª</span></div>` : `<div class="md:col-span-3 col-span-12 flex items-center justify-center border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-4"><div onclick="openSignModal(${r.id})" class="sig-box w-full hover:bg-green-50 hover:border-green-300 group"><div class="text-center group-hover:text-green-600 text-gray-400"><i class="fa-solid fa-pen-nib text-xl mb-1"></i><div class="text-xs font-bold">é»æ­¤ç°½å</div></div></div></div>`;
                    div.innerHTML = `<div class="grid grid-cols-12 gap-2 h-full">${metaHtml}${contentHtml}${actionHtml}</div>`;
                }
                t.appendChild(div);
            });
        }

        function openContentModal(rid) { editRecId = rid; const r = records.find(x => x.id === rid); document.getElementById('modalEditNote').value = r.note || ''; tempEditorImages = [...(r.imgs || [])]; renderModalImgList(); document.getElementById('contentModal').classList.remove('hidden'); }
        function closeContentModal() { document.getElementById('contentModal').classList.add('hidden'); }
        function renderModalImgList() { document.getElementById('modalImgList').innerHTML = tempEditorImages.map((src, idx) => `<img src="${src}" class="img-thumb flex-none" onclick="openPaintModal(${idx})">`).join(''); }
        function handleModalAddImage(input) { if(input.files) { Array.from(input.files).forEach(file => { const r = new FileReader(); r.onload = async (e) => { const compressed = await compressImage(e.target.result, 800, 0.6); tempEditorImages.push(compressed); renderModalImgList(); }; r.readAsDataURL(file); }); } }
        function saveModalContent() { const idx = records.findIndex(r => r.id === editRecId); if (idx > -1) { records[idx].note = document.getElementById('modalEditNote').value; records[idx].imgs = [...tempEditorImages]; save(); renderTimeline(); closeContentModal(); } }
        
        // --- Paint Logic V10.7 (Fix: Show Modal BEFORE Init Canvas) ---
        function setupPaintScene(src) {
            paintHistory = [];
            // FIX: Show modal first, so canvas has dimensions
            document.getElementById('paintModal').classList.remove('hidden');
            
            initPad('canvasPaint'); 
            pads['canvasPaint'].ctx.clearRect(0, 0, pads['canvasPaint'].c.width, pads['canvasPaint'].c.height);
            
            const container = document.getElementById('paintContainer');
            const cw = container.clientWidth; const ch = container.clientHeight;
            const img = new Image();
            img.onload = () => { drawImageFit(img, document.getElementById('canvasBg'), bgCanvasCtx, cw, ch); };
            img.src = src;
            setPen('#ef4444');
        }

        function openPaintModal(idx) { paintImgIndex = idx; isDirectEdit = false; setupPaintScene(tempEditorImages[idx]); }
        function openDirectPaint(rid, imgIdx) { directEditRecId = rid; paintImgIndex = imgIdx; isDirectEdit = true; const r = records.find(x => x.id === rid); if(r && r.imgs[imgIdx]) setupPaintScene(r.imgs[imgIdx]); }

        function savePaint() { 
            const bgC = document.getElementById('canvasBg');
            const paintC = document.getElementById('canvasPaint');
            const tempC = document.createElement('canvas');
            tempC.width = bgC.width; tempC.height = bgC.height;
            const tempCtx = tempC.getContext('2d');
            tempCtx.drawImage(bgC, 0, 0); 
            tempCtx.drawImage(paintC, 0, 0); 
            
            (async () => { 
                const d = await compressImage(tempC.toDataURL(), 800, 0.6); 
                if (isDirectEdit) {
                    const idx = records.findIndex(r => r.id === directEditRecId);
                    if(idx > -1) { records[idx].imgs[paintImgIndex] = d; save(); renderTimeline(); }
                } else {
                    tempEditorImages[paintImgIndex] = d; renderModalImgList(); 
                }
                closePaintModal(); 
            })(); 
        }
        function closePaintModal() { document.getElementById('paintModal').classList.add('hidden'); }
        function drawImageFit(img, c, ctx, cw, ch) { const r=Math.min(cw/img.width,ch/img.height),w=img.width*r,h=img.height*r,x=(cw-w)/2,y=(ch-h)/2; ctx.clearRect(0,0,cw,ch); ctx.drawImage(img,0,0,img.width,img.height,x,y,w,h); }
        
        function setPen(c) { 
            const ctx = pads['canvasPaint'].ctx; ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = c; ctx.lineWidth = 4;
            document.querySelectorAll('#paintModal button[id^="btn-"]').forEach(b => b.classList.remove('ring-2','ring-white','ring-black'));
            if(c==='#ef4444') document.getElementById('btn-red').classList.add('ring-2','ring-white');
            if(c==='#facc15') document.getElementById('btn-yellow').classList.add('ring-2','ring-white');
            if(c==='#3b82f6') document.getElementById('btn-blue').classList.add('ring-2','ring-white');
            if(c==='#22c55e') document.getElementById('btn-green').classList.add('ring-2','ring-white');
        }
        function setEraser() {
            const ctx = pads['canvasPaint'].ctx; ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = 20;
            document.querySelectorAll('#paintModal button[id^="btn-"]').forEach(b => b.classList.remove('ring-2','ring-white'));
            document.getElementById('btn-eraser').classList.add('ring-2','ring-black');
        }
        function undoPaint() {
            if(paintHistory.length > 0) {
                const lastState = paintHistory.pop(); const img = new Image();
                img.onload = () => { const ctx = pads['canvasPaint'].ctx; ctx.clearRect(0, 0, pads['canvasPaint'].c.width, pads['canvasPaint'].c.height); ctx.globalCompositeOperation = 'source-over'; ctx.drawImage(img, 0, 0); };
                img.src = lastState;
            } else { 
                const ctx = pads['canvasPaint'].ctx;
                ctx.clearRect(0, 0, pads['canvasPaint'].c.width, pads['canvasPaint'].c.height);
            }
        }

        let signingRecId = null;
        function openSignModal(rid) { signingRecId = rid; document.getElementById('signModal').classList.remove('hidden'); setTimeout(() => initPad('padSignModal'), 50); }
        function closeSignModal() { document.getElementById('signModal').classList.add('hidden'); clearPad('padSignModal'); }
        async function confirmSignModal() {
            const idx = records.findIndex(r => r.id === signingRecId);
            if (idx > -1) {
                const s = students.find(x => x.id === curSid);
                if (s.credits <= 0) return alert("å ‚æ•¸ä¸è¶³ï¼Œç„¡æ³•ç°½åˆ°ï¼");
                const sig = await compressImage(pads['padSignModal'].c.toDataURL(), 400, 0.5);
                s.credits--; records[idx].status = 'done'; records[idx].sig = sig; records[idx].date = getTimeString();
                save(); document.getElementById('dCredits').innerText = s.credits; renderTimeline(); closeSignModal(); alert("ç°½åˆ°æˆåŠŸï¼å·²æ‰£é™¤ 1 å ‚èª²");
            }
        }

        function renderList() {
            const activeTbody = document.getElementById('studentListBody'); 
            const archiveTbody = document.getElementById('archivedListBody');
            activeTbody.innerHTML = ''; archiveTbody.innerHTML = '';
            let hasArchived = false;

            students.forEach(s => {
                const tr = document.createElement('tr'); 
                const toggleId = `toggle-list-${s.id}`; 

                if (s.isArchived) {
                    hasArchived = true;
                    tr.className = "border-b bg-gray-50";
                    tr.innerHTML = `<td class="p-4 text-gray-500">${s.name}</td><td class="p-4 text-gray-400 text-sm">å·²å°å­˜</td><td class="p-4 text-gray-400">${s.credits}</td><td class="p-4 text-right"><div class="relative inline-block w-12 h-7 mr-2 align-middle select-none"><input type="checkbox" id="${toggleId}" onclick="toggleArchiveFromList(${s.id})" class="toggle-checkbox absolute block w-0 h-0 opacity-0"/><label for="${toggleId}" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label></div></td>`;
                    archiveTbody.appendChild(tr);
                } else {
                    tr.className = "border-b hover:bg-gray-50 active:bg-gray-100 transition cursor-pointer hover-effect"; tr.onclick = (e) => { if(e.target.closest('button') || e.target.closest('input') || e.target.closest('label')) return; openDetail(s.id); };
                    const timeHtml = s.schedule && s.schedule.length > 0 ? s.schedule.map(t => `<span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mr-1 mb-1 font-bold">${t}</span>`).join('') : '<span class="text-xs text-gray-300">ç„¡</span>';
                    tr.innerHTML = `<td class="p-4 font-bold text-gray-800 text-lg">${s.name}</td><td class="p-4 align-top">${timeHtml}</td><td class="p-4 font-mono font-bold text-xl ${s.credits<2?'text-red-500':'text-indigo-600'}">${s.credits}</td><td class="p-4 text-right"><button onclick="openDetail(${s.id})" class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-full shadow-sm hover:bg-indigo-100 transition flex items-center justify-center ml-auto"><i class="fa-solid fa-chevron-right"></i></button></td>`;
                    activeTbody.appendChild(tr);
                }
            });
            document.getElementById('noArchiveMsg').style.display = hasArchived ? 'none' : 'block';
            renderCalendar();
        }
        function renderCalendar() { const days = ['é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­','é€±æ—¥']; const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; days.forEach(day => { let classes = []; students.forEach(s => { if(!s.isArchived && s.schedule) s.schedule.forEach(timeStr => { if(timeStr.startsWith(day)) classes.push({ time: timeStr.split(' ')[1], name: s.name, sid: s.id }); }); }); classes.sort((a,b) => a.time.localeCompare(b.time)); const col = document.createElement('div'); col.className = "p-2 min-h-[150px]"; let cardsHtml = classes.map(c => `<div class="cal-card" onclick="openDetail(${c.sid})"><div class="font-bold text-indigo-600">${c.time}</div><div class="truncate text-gray-700 font-bold">${c.name}</div></div>`).join(''); if(classes.length === 0) cardsHtml = '<div class="text-xs text-gray-300 mt-4">-</div>'; col.innerHTML = `<div class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide sticky top-0 bg-white py-1 z-10">${day}</div>${cardsHtml}`; grid.appendChild(col); }); }
        function openDetail(sid) { try { curSid = sid; const s = students.find(x=>x.id===sid); document.getElementById('dName').innerText = s.name; document.getElementById('dCredits').innerText = s.credits; document.getElementById('dBody').innerText = s.body; document.getElementById('dSchedule').innerHTML = s.schedule && s.schedule.length ? s.schedule.map(t => `<span class="tag">${t}</span>`).join('') : '<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">æœªè¨­å®šæ™‚é–“</span>'; renderTimeline(); switchTab('page-detail'); } catch(e) { console.error(e); } }
        function viewContract() { const s = students.find(x=>x.id===curSid); const c = document.getElementById('contractContent'); c.innerHTML = ''; if(s.contractImg) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">åˆç´„ç…§ç‰‡:</p><img src="${s.contractImg}" class="w-full rounded border"></div>`; if(s.contractSigStudent) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">å­¸ç”Ÿç°½å:</p><img src="${s.contractSigStudent}" class="w-full rounded border bg-gray-50 h-24 object-contain"></div>`; if(s.contractSigTeacher) c.innerHTML += `<div><p class="text-xs text-gray-400 mb-1">è€å¸«ç°½å:</p><img src="${s.contractSigTeacher}" class="w-full rounded border bg-gray-50 h-24 object-contain"></div>`; if(s.contractDate) c.innerHTML += `<div class="text-right text-xs text-gray-400 mt-2">ç°½ç½²æ—¥æœŸ: ${s.contractDate}</div>`; document.getElementById('contractModal').classList.remove('hidden'); }
        function openRenewModal() { const m = document.getElementById('renewModal'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); document.getElementById('renewContent').classList.remove('scale-95'); }, 10); setTimeout(() => { initPad('padRenewStudent', true); initPad('padRenewTeacher', true); }, 100); }
        function closeRenewModal() { const m = document.getElementById('renewModal'); m.classList.add('opacity-0'); document.getElementById('renewContent').classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }
        async function submitRenew() { const amt = parseInt(document.getElementById('renewAmount').value); if(!amt) return alert("è«‹è¼¸å…¥å ‚æ•¸"); const sigStu = await compressImage(pads['padRenewStudent'].c.toDataURL(), 500, 0.5); const sigTea = await compressImage(pads['padRenewTeacher'].c.toDataURL(), 500, 0.5); const time = getTimeString(); const s = students.find(x=>x.id===curSid); s.credits += amt; records.unshift({ id: Date.now(), sid: curSid, date: time, type: 'renew', amount: amt, sigStudent: sigStu, sigTeacher: sigTea }); save(); document.getElementById('dCredits').innerText = s.credits; document.getElementById('renewAmount').value = ''; clearPad('padRenewStudent'); clearPad('padRenewTeacher'); closeRenewModal(); renderTimeline(); }
        function clearPad(id) { const p = pads[id]; if(!p) return; p.ctx.clearRect(0,0,p.c.width,p.c.height); if(id!=='canvasPaint'){ p.ctx.fillStyle='#ffffff'; p.ctx.fillRect(0,0,p.c.width,p.c.height); } }
        function save() { localStorage.setItem(CUR_VER + '_st',JSON.stringify(students)); localStorage.setItem(CUR_VER + '_rc',JSON.stringify(records)); localStorage.setItem(CUR_VER + '_set',JSON.stringify(appSettings)); }
        
        switchTab('page-list');
    </script>
</body>
</html>
