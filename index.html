<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <script>
        const APP_VERSION = "V17.2";
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="1on1 Pro">
    <title>1on1 Pro å®¶æ•™ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        canvas { touch-action: none; display: block; cursor: crosshair; width: 100%; height: 100%; }
        .canvas-box { border: 2px dashed #cbd5e1; border-radius: 12px; overflow: hidden; position: relative; background: white; width: 100%; min-height: 150px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ç‹€æ…‹é¡è‰² */
        .record-card { transition: all 0.2s; border-left: 5px solid transparent; }
        .record-card:active { transform: scale(0.99); }
        .record-card.status-planned { border-left-color: #fbbf24; background: white; }
        .record-card.status-done { border-left-color: #22c55e; background: #f0fdf4; }
        .record-card.status-leave { border-left-color: #9ca3af; background: #f3f4f6; opacity: 0.8; }
        .record-card.status-rescheduled { border-left-color: #f472b6; background: #fdf2f8; }
        .record-card.status-canceled { border-left-color: #ef4444; background: #fef2f2; opacity: 0.7; }

        /* é€±æ›†å¡ç‰‡ */
        .cal-card { padding: 6px; margin-bottom: 6px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.8rem; cursor: pointer; transition: transform 0.1s; user-select: none; display: flex; flex-direction: column; justify-content: center; min-height: 50px; position: relative; }
        .cal-planned { background: #fffbeb; border-left: 3px solid #fbbf24; }
        .cal-done { background: #f0fdf4; border-left: 3px solid #22c55e; }
        .cal-leave { background: #f3f4f6; border-left: 3px solid #9ca3af; color: #6b7280; text-decoration: line-through; }
        .cal-rescheduled { background: #fdf2f8; border-left: 3px solid #f472b6; }
        
        .cal-time { color: #6b7280; font-size: 0.7rem; font-weight: bold; line-height: 1.2; }
        .cal-name { color: #1f2937; font-size: 0.85rem; font-weight: bold; line-height: 1.2; margin-top: 2px; }
        
        /* å¡ç‰‡å³ä¸Šè§’é¸å–®æŒ‰éˆ• */
        .card-menu-btn { position: absolute; right: 0px; bottom: 0px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; color: #9ca3af; border-radius: 6px; z-index: 20; }
        .card-menu-btn:hover { color: #4f46e5; background-color: rgba(255,255,255,0.9); }

        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; flex-shrink: 0; background: white; }
        .img-add-btn { width: 80px; height: 80px; border-radius: 8px; border: 2px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; color: #9ca3af; cursor: pointer; flex-shrink: 0; background: #f9fafb; transition: all 0.2s; }
        .img-scroller { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }

        .col-header { display: grid; grid-template-columns: 1.2fr 2.5fr 1.2fr 0.6fr 50px; gap: 8px; padding: 12px 16px; background-color: #f3f4f6; color: #6b7280; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; }
        .student-row { display: flex; align-items: center; border-bottom: 1px solid #f3f4f6; transition: background 0.1s; min-height: 60px; }
        .student-row:hover { background-color: #f9fafb; }
        .row-info { display: grid; grid-template-columns: 1.2fr 2.5fr 1.2fr 0.6fr; gap: 8px; flex: 1; padding: 16px; cursor: pointer; height: 100%; align-items: center; }
        .row-action { width: 50px; display: flex; justify-content: center; align-items: center; border-left: 1px dashed #e5e7eb; height: 100%; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        
        #backupBanner { display: none; background-color: #fee2e2; color: #b91c1c; text-align: center; padding: 12px; font-size: 13px; font-weight: bold; border-radius: 12px; margin-bottom: 16px; border: 1px solid #fca5a5; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        .toggle-label { width: 48px; height: 28px; background-color: #d1d5db; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s ease-in-out; }
        .toggle-label:before { content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; border-radius: 50%; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-gray-800 w-full">

    <nav class="bg-white shadow-sm z-20 flex-none h-16 flex items-center justify-between px-4">
        <div class="font-bold text-xl text-indigo-600 flex items-center gap-2 select-none"><i class="fa-solid fa-user-check"></i> 1on1 Pro</div>
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg items-center">
            <button onclick="switchTab('page-list')" id="nav-list" class="px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition">èª²è¡¨</button>
            <button onclick="switchTab('page-create')" id="nav-create" class="px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition">å»ºæª”</button>
            <button onclick="switchTab('page-settings')" id="nav-settings" class="px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition relative">
                è¨­å®š
                <span id="settingsRedDot" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
            </button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 w-full max-w-6xl mx-auto no-scrollbar pb-24">
        <div id="page-create" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm max-w-2xl mx-auto space-y-5">
                <div class="flex justify-between items-center border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-700">å»ºç«‹å­¸ç”Ÿæª”æ¡ˆ</h2>
                    <label class="flex items-center gap-2 p-1 px-3 border rounded-full bg-green-50 text-green-700 font-bold whitespace-nowrap cursor-pointer text-sm">
                        <input type="checkbox" id="cIsTrial" class="w-4 h-4 accent-green-600" onchange="window.toggleCreateTrial(this)">
                        é«”é©—èª²æ¨¡å¼
                    </label>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="cName" placeholder="å­¸ç”Ÿå§“å" class="w-full p-4 border rounded-xl bg-gray-50 text-lg">
                    <input type="text" id="cBody" placeholder="å­¸ç”Ÿç‹€æ³ / å‚™è¨»" class="w-full p-4 border rounded-xl">
                    <input type="number" id="cCredits" placeholder="è³¼è²·å ‚æ•¸" class="w-full p-4 border rounded-xl bg-gray-50 text-lg">
                </div>

                <div id="cTrialSetup" class="hidden bg-green-50 p-4 rounded-xl border border-green-100 space-y-3">
                    <div class="font-bold text-green-800 text-sm"><i class="fa-solid fa-leaf"></i> é«”é©—èª²å®‰æ’</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-xs text-gray-500 font-bold">é«”é©—æ—¥æœŸ</label><input type="date" id="cTrialDate" class="w-full p-2 border rounded bg-white"></div>
                        <div>
                            <label class="text-xs text-gray-500 font-bold">æ™‚é–“</label>
                            <div class="flex gap-1">
                                <select id="cTrialHour" class="p-2 border rounded bg-white w-full"><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select>
                                <select id="cTrialMin" class="p-2 border rounded bg-white w-full"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="cRegularSetup" class="bg-blue-50 p-5 rounded-2xl border border-blue-100 space-y-4 w-full">
                    <div class="font-bold text-blue-800 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-clock"></i> é•·æœŸæ’èª²è¦å‰‡
                    </div>
                
                    <div class="grid grid-cols-12 gap-3 w-full">
                        <div class="col-span-8 flex flex-col">
                            <label class="text-xs text-gray-500 font-bold mb-1.5 block ml-1">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="cRegStart" class="appearance-none w-full p-2.5 border border-gray-200 rounded-xl bg-white h-11 text-sm outline-none box-border">
                        </div>
                        <div class="col-span-4 flex flex-col">
                            <label class="text-xs text-gray-500 font-bold mb-1.5 block ml-1">é »ç‡</label>
                            <select id="cRegFreq" class="appearance-none w-full p-2.5 border border-gray-200 rounded-xl bg-white font-bold h-11 text-sm outline-none box-border">
                                <option value="1">æ¯é€±</option>
                                <option value="2">éš”é€±</option>
                                <option value="4">æ¯æœˆ</option>
                            </select>
                        </div>
                    </div>
                
                    <div class="w-full mt-4">
                        <label class="text-xs text-gray-500 font-bold mb-1.5 block ml-1">æ™‚æ®µ (å¯å¤šé¸)</label>
                        <div class="flex gap-3 w-full">
                            <select id="cSlotDay" class="flex-1 p-2.5 border border-gray-200 rounded-xl bg-white font-bold text-sm h-11 outline-none">
                                <option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option>
                                <option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option>
                            </select>
                            <div class="flex gap-1 shrink-0">
                                <select id="cSlotHour" class="w-16 p-2.5 border border-gray-200 rounded-xl bg-white font-mono text-sm h-11 outline-none">
                                    <option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option>
                                    <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option>
                                    <option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option>
                                    <option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option>
                                </select>
                                <select id="cSlotMin" class="w-16 p-2.5 border border-gray-200 rounded-xl bg-white font-mono text-sm h-11 outline-none">
                                    <option value="00">00</option><option value="10">10</option><option value="20">20</option>
                                    <option value="30">30</option><option value="40">40</option><option value="50">50</option>
                                </select>
                            </div>
                            <button onclick="window.addCreateSlot()" class="bg-blue-600 text-white w-11 h-11 rounded-xl font-bold flex items-center justify-center shrink-0 active:scale-95 transition-transform shadow-sm">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div id="cSlotList" class="flex flex-wrap gap-2 mt-3 min-h-[44px] p-3 bg-white/50 rounded-xl border border-dashed border-blue-200"></div>
                    </div>
                </div>

                <div id="cContractSection" class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                    <button onclick="window.openContractSigner('create')" class="w-full bg-white border-2 border-dashed border-indigo-300 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50">
                        <i class="fa-solid fa-file-signature"></i> é»æ­¤é–‹å•Ÿåˆç´„ç°½ç½² (å…¨è¢å¹•)
                    </button>
                    <div id="cContractPreview" class="hidden mt-2 cursor-pointer transition hover:opacity-80" onclick="window.viewTempContract()">
                        <p class="text-xs text-green-600 font-bold mb-1">âœ“ å·²ç°½ç½² (é»æ“Šæ”¾å¤§)</p>
                        <img id="cContractThumb" class="h-20 object-contain mx-auto border bg-white rounded">
                    </div>
                </div>
                
                <button id="btnCreate" onclick="window.createStudent()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition flex justify-center items-center gap-2">
                    <span>å®Œæˆå»ºæª”</span>
                </button>
            </div>
        </div>

        <div id="page-list" class="">
            <div class="bg-white rounded-2xl shadow-sm mb-6 overflow-hidden border border-gray-100">
                <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                    <button onclick="window.changeWeek(-1)" class="w-8 h-8 rounded-full bg-white text-indigo-600 shadow-sm flex items-center justify-center hover:bg-indigo-100"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="text-center"><h3 class="font-bold text-indigo-800" id="currentWeekRange">Loading...</h3><p class="text-xs text-indigo-400 font-bold" id="currentWeekLabel">æœ¬é€±</p></div>
                    <button onclick="window.changeWeek(1)" class="w-8 h-8 rounded-full bg-white text-indigo-600 shadow-sm flex items-center justify-center hover:bg-indigo-100"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="overflow-x-auto pb-2"><div class="grid grid-cols-7 min-w-[800px] divide-x divide-gray-100 text-center" id="calendarGrid"></div></div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-h-[30vh] mb-6">
                <div class="col-header">
                    <div onclick="window.toggleSort('name')" class="cursor-pointer hover:text-indigo-600">å­¸ç”Ÿå§“å <i class="fa-solid fa-sort"></i></div>
                    <div onclick="window.toggleSort('rule')" class="cursor-pointer hover:text-indigo-600">æ’èª²è¦å‰‡ <i class="fa-solid fa-sort"></i></div>
                    <div onclick="window.toggleSort('nextDate')" class="cursor-pointer hover:text-indigo-600">ä¸‹å ‚èª² <i class="fa-solid fa-sort"></i></div>
                    <div class="text-right">å‰©é¤˜</div>
                    <div></div>
                </div>
                <div id="studentListBody" class="bg-white"></div>
            </div>

            <div class="bg-gray-50 rounded-2xl border border-gray-200 overflow-hidden mb-6"><details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer list-none p-4 text-gray-500 hover:bg-gray-100"><span class="flex items-center gap-2"><i class="fa-solid fa-box-archive"></i> å·²å°å­˜</span><span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span></summary><div class="text-gray-500 border-t border-gray-200 bg-white"><div id="archivedListBody"></div><div id="noArchiveMsg" class="p-4 text-center text-sm text-gray-300 hidden">æ²’æœ‰å°å­˜çš„å­¸ç”Ÿ</div></div></details></div>
        </div>

        <div id="page-detail" class="hidden">
            <button onclick="switchTab('page-list')" class="text-gray-500 font-bold flex items-center gap-1 bg-white px-3 py-2 rounded-lg shadow-sm mb-4 w-fit"><i class="fa-solid fa-chevron-left"></i> è¿”å›èª²è¡¨</button>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex-1"><div class="flex items-center gap-3 mb-1"><h2 id="dName" class="text-3xl font-bold text-gray-800"></h2><span id="dTrialTag" class="hidden bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">ğŸŒ± é«”é©—</span><button onclick="window.openProfileModal()" class="text-gray-400 hover:text-indigo-600"><i class="fa-solid fa-gear fa-lg"></i></button></div><div id="dRuleDisplay" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded inline-block mt-1"></div><p id="dBody" class="text-xs text-red-500 font-bold mt-2 bg-red-50 inline-block px-2 py-1 rounded border border-red-100"></p></div>
                <div class="bg-indigo-600 rounded-xl p-4 text-white shadow-md flex items-center gap-6 min-w-[200px] justify-between w-full md:w-auto"><div><p class="text-indigo-200 text-xs font-bold uppercase">å‰©é¤˜å ‚æ•¸</p><p id="dCredits" class="text-4xl font-mono font-bold leading-none">0</p></div><button onclick="window.openRenewModal()" class="bg-white text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-50 transition active:scale-95 whitespace-nowrap"><i class="fa-solid fa-plus"></i> è³¼èª²/çºŒç´„</button></div>
            </div>
            <div class="max-w-4xl mx-auto">
                <button onclick="window.addNewRecord()" class="w-full bg-white border-2 border-dashed border-indigo-200 text-indigo-600 py-4 rounded-2xl font-bold text-lg hover:bg-indigo-50 transition mb-6 shadow-sm"><i class="fa-solid fa-plus-circle"></i> æ’å…¥å–®å ‚æ–°èª²ç¨‹</button>
                <div id="timeline" class="space-y-4 pb-20"></div>
                <div id="dContractArea" class="hidden"></div>
            </div>
        </div>

        <div id="page-settings" class="hidden">
            <div class="max-w-2xl mx-auto space-y-6 pt-4">
                
                <div id="backupBanner">âš ï¸ æ‚¨å·²è¶…é 7 å¤©æœªå‚™ä»½ï¼Œå»ºè­°ç«‹å³ä¸‹è¼‰ï¼</div>
                <button onclick="document.getElementById('guideModal').classList.remove('hidden')" class="w-full bg-white text-indigo-600 font-bold text-sm py-3 rounded-xl border border-gray-200 shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 mt-6">
                    <i class="fa-solid fa-book-open"></i> æŸ¥çœ‹ä½¿ç”¨æ•™å­¸
                </button>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-700 mb-4"><i class="fa-solid fa-file-contract text-indigo-500 mr-2"></i> å…¬ç‰ˆåˆç´„è¨­å®š</h3>
                    <p class="text-sm text-gray-500 mb-4">ä¸Šå‚³åˆç´„åº•åœ– (JPG/PNG)</p>
                    <input type="file" id="sysContractTemplate" accept="image/png, image/jpeg, image/jpg" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" onchange="window.saveContractTemplate(this)">
                    <img id="sysContractPreview" class="mt-4 w-full h-40 object-contain border rounded bg-gray-50 hidden cursor-pointer hover:opacity-90 transition" onclick="window.previewContractSetting()">
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-700 mb-4">
                        <i class="fa-solid fa-cloud-arrow-down text-indigo-500 mr-2"></i> å‚™ä»½èˆ‡é‚„åŸ
                    </h3>
                    
                    <div class="mb-4 bg-gray-50 p-4 rounded-xl border border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-3">
                        <div class="text-sm text-gray-600 font-bold flex flex-col sm:flex-row items-start sm:items-center gap-2">
                            <span><i class="fa-solid fa-clock-rotate-left mr-2 text-gray-400"></i> ä¸Šæ¬¡å‚™ä»½ï¼š<span id="lastBackupTime" class="text-indigo-600 ml-1">è®€å–ä¸­...</span></span>
                            <span class="text-xs text-gray-400 sm:ml-4 sm:pl-4 sm:border-l border-gray-300">ğŸ“¦ è³‡æ–™åº«å¤§å°ï¼š<span id="dbSizeDisplay" class="text-gray-600 font-mono">è¨ˆç®—ä¸­...</span></span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <label for="backupFreq" class="text-xs font-bold text-gray-500">æé†’é »ç‡ï¼š</label>
                            <select id="backupFreq" onchange="window.saveSettings()" class="text-xs border border-gray-300 rounded-lg p-2 bg-white font-bold text-gray-700 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer hover:bg-gray-50">
                                <option value="3">æ¯ 3 å¤©</option>
                                <option value="7">æ¯ 7 å¤©</option>
                                <option value="14">æ¯ 14 å¤©</option>
                                <option value="30">æ¯ 30 å¤©</option>
                                <option value="-1">é—œé–‰æé†’</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="window.backupData()" class="flex-1 bg-indigo-50 text-indigo-600 px-4 py-3 rounded-xl font-bold border border-indigo-100 hover:bg-indigo-100 transition flex items-center justify-center gap-2 active:scale-95">
                            <i class="fa-solid fa-download"></i> ä¸‹è¼‰å‚™ä»½
                        </button>
                        
                        <label class="flex-1 bg-white text-gray-600 px-4 py-3 rounded-xl font-bold border border-gray-300 hover:bg-gray-50 transition flex items-center justify-center gap-2 cursor-pointer active:scale-95">
                            <i class="fa-solid fa-upload"></i> é‚„åŸ (è®€å–)
                            <input type="file" id="importFile" accept=".json" class="hidden" onchange="window.restoreData(this)">
                        </label>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-700 mb-4"><i class="fa-solid fa-calendar-days text-indigo-500 mr-2"></i> åœ‹å®šå‡æ—¥è¨­å®š</h3>
                    <p class="text-sm text-gray-600 mb-2">å·²å…§å»º 2026 å°ç£åœ‹å®šå‡æ—¥ã€‚å¦‚éœ€æ›´æ–°æœªä¾†å¹´ä»½ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚</p>
                    <div class="flex gap-2">
                        <button onclick="window.updateOnlineHolidays()" class="flex-1 bg-green-50 text-green-700 px-3 py-2 rounded-lg font-bold border border-green-200 hover:bg-green-100 transition text-xs sm:text-sm">
                            â˜ï¸ é€£ç¶²æ›´æ–°æ˜å¹´å‡æ—¥
                        </button>
                        <label class="flex-1 bg-gray-50 text-gray-600 px-3 py-2 rounded-lg font-bold border border-gray-200 hover:bg-gray-100 transition cursor-pointer text-center text-xs sm:text-sm flex flex-col justify-center">
                            <span>ğŸ“‚ æ‰‹å‹•åŒ¯å…¥ JSON</span>
                            <input type="file" accept=".json" class="hidden" onchange="window.importHolidays(this)">
                        </label>
                    </div>
                </div>
                
                <div class="text-center pt-8 border-t border-gray-200">
                    <button onclick="window.emergencyReset()" class="text-xs text-red-400 font-bold bg-red-50 border border-red-100 px-3 py-2 rounded-full hover:bg-red-500 hover:text-white transition">âš ï¸ å®Œæ•´é‡ç½®ç³»çµ± (æ¸…ç©ºè³‡æ–™)</button>
                    
                    <div onclick="window.location.reload(true)" class="cursor-pointer active:scale-95 transition mt-4 p-2">
                        <p class="text-[10px] text-gray-400 font-bold" id="ver-footer"></p>
                        <p class="text-[9px] text-gray-300 mt-1">
                            <i class="fa-solid fa-rotate-right"></i> é»æ“Šæ­¤è™•æ›´æ–°ç‰ˆæœ¬
                        </p>
                    </div>
                    </div>
            </div>
        </div>
    </main>
    
    <div id="toast">å·²å„²å­˜</div>

    <div id="profileModal" class="fixed inset-0 z-50 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl relative overflow-hidden flex flex-col max-h-[90vh]"><h3 class="font-bold text-xl mb-4 border-b pb-2 flex-none">å­¸ç”Ÿè¨­å®š</h3><div class="space-y-5 overflow-y-auto no-scrollbar flex-1 pb-4">
        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl"><div><label class="text-xs text-gray-500 font-bold">å§“å</label><input type="text" id="pName" class="w-full bg-transparent border-b border-gray-300 font-bold"></div><div class="flex flex-col items-end"><span id="pArchivedStatus" class="text-xs font-bold text-green-600 mb-1">æ´»èº</span><div class="relative inline-block w-10 h-6 align-middle select-none"><input type="checkbox" id="pArchivedToggle" class="toggle-checkbox absolute block w-0 h-0 opacity-0" onchange="window.toggleArchivedStatusInModal()"/><label for="pArchivedToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div></div>
        <div><label class="text-xs text-gray-500 font-bold">ç‹€æ³å‚™è¨»</label><input type="text" id="pBody" class="w-full p-3 border rounded-xl bg-gray-50"></div>
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4"><div class="flex justify-between items-center"><label class="text-sm font-bold text-indigo-800"><i class="fa-solid fa-calendar-check mr-1"></i> æ’èª²è¦å‰‡</label></div><div><label class="text-xs text-gray-500 font-bold mb-1 block">ä¸Šèª²é »ç‡</label><select id="ruleFreq" class="w-full p-2 border rounded bg-white font-bold text-gray-700"><option value="1">æ¯é€± (Weekly)</option><option value="2">éš”é€± (Every 2 Weeks)</option><option value="4">æ¯æœˆ (Every 4 Weeks)</option></select></div><div><label class="text-xs text-gray-500 font-bold mb-1 block">æ–°å¢ä¸Šèª²æ™‚æ®µ</label><div class="flex gap-1 mb-2"><select id="slotDay" class="p-2 border rounded bg-white font-bold"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option><option value="6">é€±å…­</option><option value="0">é€±æ—¥</option></select>
        <select id="slotHour" class="p-2 border rounded bg-white font-mono"><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select>
        <select id="slotMin" class="p-2 border rounded bg-white font-mono"><option value="00">00</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select><button onclick="window.addSlot()" class="bg-indigo-500 text-white px-3 rounded font-bold">ï¼‹</button></div><div id="slotList" class="flex flex-wrap gap-2 min-h-[30px]"></div></div><div><label class="text-xs text-gray-500 font-bold mb-1 block">é–‹å§‹æ—¥æœŸ</label><input type="date" id="ruleStartDate" class="w-full p-2 border rounded bg-white text-sm"></div><button onclick="window.generateSchedule()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow hover:bg-indigo-700 active:scale-95 transition"><i class="fa-solid fa-wand-magic-sparkles"></i> é‡æ–°å®‰æ’é å®šèª²ç¨‹</button></div>
        <div class="mt-4 pt-4 border-t"><h4 class="font-bold text-gray-500 mb-2 text-sm">åˆç´„ç®¡ç†</h4><div id="pContractArea" class="bg-gray-50 p-2 rounded-xl border border-gray-200 text-center"></div></div></div>
        <div class="flex gap-3 mt-4 pt-4 border-t bg-white flex-none"><button onclick="document.getElementById('profileModal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">é—œé–‰</button><button onclick="window.saveProfile()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow">å„²å­˜è¨­å®š</button></div>
        <div class="text-center mt-2 flex-none"><button onclick="window.deleteStudent()" class="text-xs text-red-400 hover:text-red-600 hover:underline"><i class="fa-solid fa-trash"></i> æ°¸ä¹…åˆªé™¤æ­¤å­¸ç”Ÿ</button></div>
    </div></div>
    
    <div id="actionModal" class="fixed inset-0 z-50 bg-black bg-opacity-60 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl relative">
            <button onclick="document.getElementById('actionModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark fa-xl"></i>
            </button>
            <h3 class="font-bold text-lg mb-2 text-center">èª²ç¨‹ç®¡ç†</h3>
            
            <div id="actionStatusHint" class="text-center text-xs font-bold text-red-500 mb-2 h-4"></div>
            
            <div class="text-center text-sm text-gray-500 mb-2" id="actionCurrentTime"></div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
                <label class="text-xs font-bold text-gray-500 block mb-2">æ›´æ”¹æ™‚é–“</label>
                <input type="datetime-local" id="actionNewTime" class="w-full p-3 border rounded-xl bg-white text-lg">
            </div>
            <div id="actionModalFooter" class="flex gap-3">
                <button id="btnActionReschedule" onclick="window.submitReschedule()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <i class="fa-regular fa-calendar-check mr-1"></i> æ”¹æœŸ
                </button>
                <button id="btnActionLeave" onclick="window.submitLeave()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl border border-gray-200 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <i class="fa-solid fa-mug-hot mr-1"></i> è«‹å‡
                </button>
            </div>
        </div>
    </div>

    <div id="signModal" class="fixed inset-0 z-40 bg-black bg-opacity-60 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md p-5 rounded-2xl shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">å­¸ç”Ÿç°½åˆ°</h3><button onclick="window.clearPad('padSignModal')" class="text-xs text-red-500 font-bold">æ¸…é™¤é‡ç°½</button></div><div class="canvas-box h-48 bg-gray-50 mb-4"><canvas id="padSignModal"></canvas></div><div class="flex gap-3"><button onclick="window.closeSignModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button><button onclick="window.confirmSignModal()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg">ç¢ºèª (æ‰£1å ‚)</button></div></div></div>
    
    <div id="paintModal" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col"><div class="flex justify-between items-center p-4 bg-gray-800 text-white safe-top"><div class="flex gap-2"><button onclick="window.closePaintModal()" class="px-3 py-2 text-gray-300 font-bold hover:text-white">å–æ¶ˆ</button><button onclick="window.undoPaint()" class="px-3 py-2 bg-gray-700 rounded-lg font-bold hover:bg-gray-600"><i class="fa-solid fa-rotate-left"></i></button></div><h3 class="font-bold" id="paintTitle">åœ–ç‰‡æ¨™è¨»</h3><button onclick="window.savePaint()" class="px-4 py-2 bg-indigo-500 rounded-lg font-bold shadow hover:bg-indigo-600">å®Œæˆ</button></div><div class="flex-1 relative bg-black flex items-center justify-center overflow-hidden" id="paintContainer"><canvas id="canvasBg" class="absolute inset-0 pointer-events-none"></canvas><canvas id="canvasPaint" class="absolute inset-0 z-10 cursor-crosshair"></canvas></div><div class="p-6 bg-gray-800 flex justify-center gap-4 safe-bottom overflow-x-auto"><button onclick="window.setPen('#000000')" class="w-12 h-12 rounded-full bg-black border-4 border-gray-600 flex-shrink-0" id="btn-black"></button><button onclick="window.setPen('#ffffff')" class="w-12 h-12 rounded-full bg-white border-4 border-gray-600 flex-shrink-0" id="btn-white"></button><button onclick="window.setPen('#ef4444')" class="w-12 h-12 rounded-full bg-red-500 border-4 border-gray-700 ring-2 ring-white flex-shrink-0" id="btn-red"></button><button onclick="window.setPen('#facc15')" class="w-12 h-12 rounded-full bg-yellow-400 border-4 border-gray-700 flex-shrink-0" id="btn-yellow"></button><button onclick="window.setPen('#3b82f6')" class="w-12 h-12 rounded-full bg-blue-500 border-4 border-gray-700 flex-shrink-0" id="btn-blue"></button><button onclick="window.setPen('#22c55e')" class="w-12 h-12 rounded-full bg-green-500 border-4 border-gray-700 flex-shrink-0" id="btn-green"></button><div class="w-px h-12 bg-gray-600 mx-2"></div><button onclick="window.setEraser()" class="w-12 h-12 rounded-full bg-gray-200 border-4 border-gray-700 text-gray-600 flex items-center justify-center flex-shrink-0" id="btn-eraser"><i class="fa-solid fa-eraser"></i></button></div></div>
    
    <div id="renewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm"><div class="bg-white w-[90%] max-w-lg p-6 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-200" id="renewContent"><h3 class="text-xl font-bold mb-4 text-center">è³¼è²· / çºŒç´„</h3><div class="space-y-4"><input type="number" id="renewAmount" class="w-full p-4 border rounded-2xl text-2xl font-bold text-center outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥å ‚æ•¸"><div class="grid grid-cols-2 gap-3"><div class="bg-gray-50 p-2 rounded-xl border"><div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">å­¸ç”Ÿç°½å</label><button onclick="window.clearPad('padRenewStudent')" class="text-xs text-red-400">æ¸…é™¤</button></div><div class="canvas-box h-24 bg-white"><canvas id="padRenewStudent"></canvas></div></div><div class="bg-gray-50 p-2 rounded-xl border"><div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-400">è€å¸«ç°½å</label><button onclick="window.clearPad('padRenewTeacher')" class="text-xs text-red-400">æ¸…é™¤</button></div><div class="canvas-box h-24 bg-white"><canvas id="padRenewTeacher"></canvas></div></div></div><div class="flex gap-3 mt-2"><button onclick="window.closeRenewModal()" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200">å–æ¶ˆ</button><button onclick="window.submitRenew()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700">ç¢ºèªè³¼è²·</button></div></div></div></div>
    
    <div id="imageModal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="relative max-w-full max-h-full" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('imageModal').classList.add('hidden')" class="absolute -top-12 right-0 text-white text-xl font-bold p-2 hover:text-gray-300">
                <i class="fa-solid fa-xmark fa-lg"></i>
            </button>
            <img id="imageModalContent" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <div id="guideModal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-80 hidden flex items-center justify-center p-2 sm:p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl max-h-[90vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            
            <div class="bg-indigo-600 p-5 text-white flex justify-between items-center shrink-0">
                <div>
                    <h3 class="font-bold text-2xl tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-book-open"></i> 
                        1on1 Pro ä½¿ç”¨æ‰‹å†Š 
                        <span id="ver-guide-subtitle" class="text-lg font-normal text-indigo-200 ml-1"></span>
                    </h3>
                    <p class="text-indigo-100 text-sm mt-1" id="ver-guide-subtitle"></p>
                </div>
                <button onclick="document.getElementById('guideModal').classList.add('hidden')" class="bg-white/10 hover:bg-white/20 p-2 rounded-full w-10 h-10 transition flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="space-y-6 p-6 overflow-y-auto bg-gray-50 text-gray-700 leading-relaxed flex-1">

                <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 shadow-sm">
                    <h4 class="text-indigo-700 font-bold text-lg mb-3 flex items-center">
                        <i class="fa-solid fa-lightbulb mr-2 text-yellow-500"></i> æ ¸å¿ƒè§€å¿µï¼šè‡ªå‹•æ’èª²
                    </h4>
                    <p class="text-sm text-gray-700 mb-3 leading-relaxed">
                        æœ¬ç³»çµ±æ¡ç”¨<b>ã€Œå ‚æ•¸ç®¡ç†åˆ¶ã€</b> æ‚¨åªéœ€è¼¸å…¥è³¼è²·å ‚æ•¸ï¼Œç³»çµ±ä¾¿æœƒä¾ç…§è¦å‰‡<b>è‡ªå‹•ç”¢ç”Ÿæ‰€æœ‰ä¸Šèª²æ—¥æœŸ</b>ï¼Œçœå»æ‰‹å‹•æ’èª²çš„éº»ç…©
                    </p>
                    <ul class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                        <li class="bg-white p-3 rounded-lg border border-indigo-100 flex flex-col">
                            <span class="text-indigo-600 font-bold mb-1"><i class="fa-solid fa-ruler-combined"></i> è¨­å®šè¦å‰‡</span>
                            <span class="text-xs text-gray-500">åœ¨å­¸ç”Ÿæª”æ¡ˆè¨­å®šã€Œæ¯é€±/éš”é€±ã€åŠä¸Šèª²æ™‚æ®µ</span>
                        </li>
                        <li class="bg-white p-3 rounded-lg border border-indigo-100 flex flex-col">
                            <span class="text-indigo-600 font-bold mb-1"><i class="fa-solid fa-coins"></i> è³¼è²·å ‚æ•¸</span>
                            <span class="text-xs text-gray-500">è¼¸å…¥è³¼è²·å ‚æ•¸ï¼Œç³»çµ±è‡ªå‹•å¾€å¾Œæ¨ç®—èª²ç¨‹</span>
                        </li>
                        <li class="bg-white p-3 rounded-lg border border-indigo-100 flex flex-col">
                            <span class="text-indigo-600 font-bold mb-1"><i class="fa-solid fa-forward"></i> è‡ªå‹•é †å»¶</span>
                            <span class="text-xs text-gray-500">å­¸ç”Ÿè«‹å‡æ™‚ï¼Œå¯é¸æ“‡è‡ªå‹•å°‡èª²ç¨‹å¾€å¾Œé †å»¶</span>
                        </li>
                    </ul>
                </div>
            
                <div>
                    <h4 class="font-bold text-gray-800 mb-4 pl-2 border-l-4 border-indigo-500" id="ver-guide-header">åŠŸèƒ½ç¸½è¦½</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="text-indigo-600 font-bold mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-user-graduate bg-indigo-100 p-2 rounded-lg"></i> å­¸ç”Ÿç®¡ç†
                            </div>
                            <ul class="text-xs text-gray-600 space-y-2 pl-1">
                                <li>â€¢ <b>å®Œæ•´å»ºæª”</b>ï¼šæ”¯æ´ä¸€èˆ¬ç”Ÿèˆ‡é«”é©—èª²æ¨¡å¼</li>
                                <li>â€¢ <b>è¦å‰‡æ’èª²</b>ï¼šæ”¯æ´æ¯é€±ã€éš”é€±ã€æ¯æœˆé »ç‡</li>
                                <li>â€¢ <b>åˆç´„ç®¡ç†</b>ï¼šä¸Šå‚³åº•åœ–ï¼Œç›´æ¥åœ¨å¹³æ¿ç°½ç½²</li>
                            </ul>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="text-green-600 font-bold mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-calendar-days bg-green-100 p-2 rounded-lg"></i> èª²è¡¨ç´€éŒ„
                            </div>
                            <ul class="text-xs text-gray-600 space-y-2 pl-1">
                                <li>â€¢ <b>é€±æ›†æª¢è¦–</b>ï¼šä¸€ç›®ç­ç„¶ï¼Œæ”¯æ´åœ‹å®šå‡æ—¥</li>
                                <li>â€¢ <b>ä¸Šèª²ç´€éŒ„</b>ï¼šå¯ç­†è¨˜ã€ä¸Šå‚³ç…§ç‰‡ä¸¦ç•«è¨˜</li>
                                <li>â€¢ <b>é›»å­ç°½åˆ°</b>ï¼šå­¸ç”Ÿç°½åå¾Œè‡ªå‹•æ‰£é™¤å ‚æ•¸</li>
                            </ul>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="text-gray-600 font-bold mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-gear bg-gray-100 p-2 rounded-lg"></i> ç³»çµ±è¨­å®š
                            </div>
                            <ul class="text-xs text-gray-600 space-y-2 pl-1">
                                <li>â€¢ <b>è³‡æ–™å‚™ä»½</b>ï¼šä¸€éµä¸‹è¼‰/é‚„åŸ JSON æª”</li>
                                <li>â€¢ <b>é›¢ç·šä½¿ç”¨</b>ï¼šç„¡ç¶²è·¯ä¹Ÿèƒ½æ“ä½œ</li>
                                <li>â€¢ <b>å‡æ—¥åŒ¯å…¥</b>ï¼šé€£ç¶²å¯è‡ªå‹•æ›´æ–°åœ‹è¨‚å‡æ—¥</li>
                            </ul>
                        </div>
                    </div>
                </div>
            
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h4 class="font-bold text-gray-700 text-sm mb-3">ğŸ¨ èª²ç¨‹ç‹€æ…‹ç‡ˆè™Ÿ</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                        <div class="flex items-center gap-2 bg-white p-2 rounded border border-yellow-200">
                            <span class="w-3 h-3 rounded-full bg-yellow-400 shrink-0"></span>
                            <span><b>é å®š</b> (Planned)</span>
                        </div>
                        <div class="flex items-center gap-2 bg-white p-2 rounded border border-green-200">
                            <span class="w-3 h-3 rounded-full bg-green-500 shrink-0"></span>
                            <span><b>å®Œæˆ</b> (æ‰£å ‚æ•¸)</span>
                        </div>
                        <div class="flex items-center gap-2 bg-white p-2 rounded border border-gray-300">
                            <span class="w-3 h-3 rounded-full bg-gray-400 shrink-0"></span>
                            <span><b>è«‹å‡</b> (ä¸æ‰£å ‚/è‡ªå‹•é †å»¶èª²ç¨‹)</span>
                        </div>
                        <div class="flex items-center gap-2 bg-white p-2 rounded border border-pink-200">
                            <span class="w-3 h-3 rounded-full bg-pink-400 shrink-0"></span>
                            <span><b>æ”¹æœŸ</b> (Rescheduled)</span>
                        </div>
                    </div>
                </div>

                <div class="bg-red-50 border border-red-100 rounded-xl p-4 flex gap-3 items-start shadow-sm">
                    <div class="text-red-500 text-xl mt-0.5"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div>
                        <h5 class="font-bold text-red-800 text-sm mb-1">é—œæ–¼è³‡æ–™å‚™ä»½ (éå¸¸é‡è¦ï¼)</h5>
                        <p class="text-red-700 text-xs leading-relaxed mb-1">
                            æœ¬ç³»çµ±è³‡æ–™å®Œå…¨å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚<b>è‹¥æ¸…é™¤ç´€éŒ„æˆ–æ›´æ›æ‰‹æ©Ÿï¼Œè³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚</b>
                        </p>
                        <p class="text-red-600 text-xs font-bold">
                            ğŸ‘‰ è«‹å‹™å¿…å®šæœŸåˆ°ã€Œè¨­å®šã€é é¢é»æ“Š [ä¸‹è¼‰å‚™ä»½]ï¼Œä¸¦å­˜åˆ°é›²ç«¯ç¡¬ç¢Ÿã€‚
                        </p>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-5 rounded-2xl border border-indigo-100 shadow-sm relative overflow-hidden">
    
                    <div class="absolute top-0 right-0 opacity-5 text-indigo-900 text-9xl -mr-4 -mt-4 pointer-events-none">
                        <i class="fa-solid fa-mobile-screen"></i>
                    </div>
                
                    <h4 class="font-bold text-lg mb-3 flex items-center text-indigo-800 relative z-10">
                        <i class="fa-solid fa-download mr-2 text-indigo-600"></i> æŠŠç¶²é å­˜åˆ°æ¡Œé¢ï¼Œæ“ä½œæ›´æ–¹ä¾¿ï¼
                    </h4>
                    
                    <p class="text-sm text-indigo-900/80 mb-4 relative z-10">
                        æ¨è–¦æ‚¨æŠŠç¶²é å­˜åˆ°æ¡Œé¢æ·å¾‘ã€‚é€™æ¨£ä¸ä½†æœ‰å…¨è¢å¹•è¦–çª—ï¼Œæ“ä½œä¹Ÿæœƒåƒ App ä¸€æ¨£æµæš¢ï¼Œå¿«ä¾†è©¦è©¦çœ‹å§ï¼
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
                        <div class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-2 text-sm flex items-center">
                                <i class="fa-brands fa-apple text-xl mr-2"></i> iOS (iPad/iPhone)
                            </h5>
                            <ol class="list-decimal pl-4 text-xs text-gray-600 space-y-1.5 font-medium">
                                <li>é–‹å•Ÿ <b>Safari</b> ç€è¦½å™¨ã€‚</li>
                                <li>é»æ“Šã€Œ<b>åˆ†äº«æŒ‰éˆ•</b>ã€<i class="fa-solid fa-arrow-up-from-bracket mx-1 text-blue-500"></i>ã€‚</li>
                                <li>å¾€ä¸‹æ»‘æ‰¾åˆ°ä¸¦é»é¸ã€Œ<b>åŠ å…¥ä¸»ç•«é¢</b>ã€ã€‚</li>
                            </ol>
                        </div>
                
                        <div class="bg-white p-4 rounded-xl border border-green-100 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-2 text-sm flex items-center">
                                <i class="fa-brands fa-android text-green-500 text-xl mr-2"></i> Android
                            </h5>
                            <ol class="list-decimal pl-4 text-xs text-gray-600 space-y-1.5 font-medium">
                                <li>é–‹å•Ÿ <b>Chrome</b> ç€è¦½å™¨ã€‚</li>
                                <li>é»æ“Šå³ä¸Šè§’çš„ã€Œ<b>é¸å–®</b>ã€<i class="fa-solid fa-ellipsis-vertical mx-1 text-gray-400"></i>ã€‚</li>
                                <li>é¸æ“‡ã€Œ<b>å®‰è£æ‡‰ç”¨ç¨‹å¼</b>ã€æˆ–ã€Œ<b>åŠ åˆ°ä¸»ç•«é¢</b>ã€ã€‚</li>
                            </ol>
                        </div>
                    </div>
                
                    <div class="mt-4 pt-3 border-t border-indigo-200/50 text-[11px] text-indigo-400 text-center font-bold relative z-10">
                        ğŸ’¡ å°æ’‡æ­¥ï¼šè‹¥æœªä¾†ç‰ˆæœ¬æ›´æ–°ï¼Œè«‹é»æ“Šã€Œè¨­å®šã€é é¢æœ€ä¸‹æ–¹çš„ç‰ˆæœ¬è™Ÿä¾†å¼·åˆ¶æ›´æ–°ã€‚
                    </div>
                </div>
            
                
            
            </div>

            <div class="p-4 bg-gray-100 border-t flex justify-end shrink-0">
                <button onclick="document.getElementById('guideModal').classList.add('hidden')" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold transition shadow-sm">
                    æˆ‘ç­è§£äº†
                </button>
            </div>
        </div>
    </div>

    <script>

        // ===  IndexedDB Core Engine  ===
        const DB_NAME = '1on1Pro_V16_IDB';
        const STORE_NAME = 'store';
        const MASTER_KEY = 'master_data';
        const pads = {};
        
        // State
        let students = [], records = []; 
        let appSettings = { lastBackup: null, freq: '7', contractTemplate: null, holidays: {} };
        let curSid = null, signingRecId = null, directEditRecId = null, paintImgIndex = -1;
        let isDirectEdit = false, paintHistory = [], bgCanvasCtx = null;
        let currentWeekStart = new Date();
        let ruleSlots = [], createSlots = [];
        let currentView = 'calendar';
        let paintMode = 'photo';
        let tempContractImg = null;
        let targetRecId = null;
        let currentSort = { key: 'name', asc: true }; // é è¨­æŒ‰å§“åå‡å†ªæ’åº

        // å…§å»ºå‡æ—¥è³‡æ–™ (2025-2026 å®Œæ•´ç‰ˆ)
        const builtInHolidays = {
            "2026-01-01": "å…ƒæ—¦",
            "2026-02-14": "å°å¹´å¤œ(å½ˆæ€§)", // 2/14 è£œç­æ—¥æ”¾å‡
            "2026-02-15": "å°å¹´å¤œ",       // é€£å‡é–‹å§‹
            "2026-02-16": "é™¤å¤•",
            "2026-02-17": "æ˜¥ç¯€",
            "2026-02-18": "æ˜¥ç¯€",
            "2026-02-19": "æ˜¥ç¯€",
            "2026-02-20": "æ˜¥ç¯€",
            "2026-02-21": "æ˜¥ç¯€",         // é€±å…­
            "2026-02-22": "æ˜¥ç¯€",         // é€±æ—¥
            "2026-02-28": "å’Œå¹³ç´€å¿µæ—¥",
            "2026-04-03": "å…’ç«¥ç¯€", "2026-04-04": "æ¸…æ˜ç¯€", "2026-04-05": "é€£å‡", "2026-04-06": "è£œå‡",
            "2026-06-19": "ç«¯åˆç¯€", "2026-06-20": "é€£å‡", "2026-06-21": "é€£å‡",
            "2026-09-25": "ä¸­ç§‹ç¯€", "2026-09-26": "é€£å‡", "2026-09-27": "é€£å‡",
            "2026-10-10": "åœ‹æ…¶æ—¥", "2026-10-11": "é€£å‡"
        };
        

        // === IndexedDB Wrapper ===
        const db = {
            init: () => new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = e => {
                    const d = e.target.result;
                    if(!d.objectStoreNames.contains(STORE_NAME)) d.createObjectStore(STORE_NAME);
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            }),
            put: async (data) => {
                const d = await db.init();
                return new Promise((resolve, reject) => {
                    const tx = d.transaction(STORE_NAME, 'readwrite');
                    const req = tx.objectStore(STORE_NAME).put(data, MASTER_KEY);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },
            get: async () => {
                const d = await db.init();
                return new Promise((resolve, reject) => {
                    const tx = d.transaction(STORE_NAME, 'readonly');
                    const req = tx.objectStore(STORE_NAME).get(MASTER_KEY);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }
        };

        // === Initialization Logic ===
        async function initApp() {
            document.title = `1on1 Pro å®¶æ•™ç®¡ç†ç³»çµ± (${APP_VERSION})`; // æ›´æ–°ç¶²é æ¨™é¡Œ
            const verDisplay = {
                'ver-footer': `1on1 Pro ${APP_VERSION}`,
                'ver-guide-subtitle': ` (${APP_VERSION})`,
                'ver-guide-header': `ğŸ› ï¸ ${APP_VERSION} ç›®å‰åŠŸèƒ½`
            };
            for (const [id, text] of Object.entries(verDisplay)) {
                const el = document.getElementById(id);
                if(el) el.innerText = text;
            }

            try {
                let data = await db.get();
                if(!data) {
                    const oldDB = localStorage.getItem('1ON1_PRO_MASTER_DB') || localStorage.getItem('ONE_PRO_V15_STABLE');
                    if(oldDB) { 
                        data = JSON.parse(oldDB); 
                        await db.put(data); 
                        localStorage.removeItem('1ON1_PRO_MASTER_DB'); 
                        localStorage.removeItem('ONE_PRO_V15_STABLE'); 
                        alert("ğŸ‰ ç³»çµ±å‡ç´šæˆåŠŸï¼šè³‡æ–™å·²é·ç§»è‡³å¤§å®¹é‡è³‡æ–™åº« (IndexedDB)ï¼"); 
                    }
                }

                if(data) {
                    students = data.students || [];
                    records = data.records || [];
                    appSettings = data.appSettings || appSettings;
                    
                    // è‡ªå‹•ä¿®å¾©ï¼šéæ¿¾æ‰å£æ‰çš„èª²ç¨‹ç´€éŒ„
                    records = records.filter(r => r && r.date && typeof r.date === 'string');
                }

                // ğŸŸ¢ é—œéµä¿®æ­£ï¼šé€™è£¡å°±æ˜¯å°‡ã€Œå…§å»ºå‡æ—¥ã€è¼‰å…¥ç³»çµ±çš„åœ°æ–¹
                // å¦‚æœç³»çµ±é‚„æ²’æœ‰å‡æ—¥è¨­å®šï¼Œæˆ–æ˜¯è¦è£œé½Šç¼ºå°‘çš„å‡æ—¥
                if(!appSettings.holidays) appSettings.holidays = {};
                for(const [k, v] of Object.entries(builtInHolidays)) {
                    // åªæœ‰ç•¶é‚£å¤©åŸæœ¬æ²’è³‡æ–™æ™‚ï¼Œæ‰è£œä¸Šå» (é¿å…è¦†è“‹æ‚¨æ‰‹å‹•ä¿®æ”¹éçš„)
                    if(!appSettings.holidays[k]) appSettings.holidays[k] = v;
                }

                if(appSettings.contractTemplate) {
                    const img = document.getElementById('sysContractPreview');
                    if(img) {
                        img.src = appSettings.contractTemplate;
                        img.classList.remove('hidden');
                    }
                }
                checkBackupStatus();
            } catch(e) {
                console.error("Boot Error:", e);
                alert("è³‡æ–™åº«è¼‰å…¥å¤±æ•—");
            }

            const d = new Date();
            d.setHours(0,0,0,0);
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            currentWeekStart = new Date(d.setDate(diff));
            
            try { 
                renderList(); 
            } catch(e) { 
                console.error("Render List Error", e); 
            }
        }

        window.onload = initApp;

        window.addEventListener('beforeunload', (e) => {
            if(!appSettings.lastBackup) return;
            const today = getFmtDate(new Date());
            if(appSettings.lastBackup !== today) {
                e.preventDefault();
                e.returnValue = ''; 
            }
        });

        async function saveData() {
            try {
                const data = { students, records, appSettings };
                await db.put(data);
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            } catch(e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
            }
        }

        function getFmtDate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // === Conflict Check Logic ===
        function checkConflict(dateStr, excludeRecId = null) {
            try {
                const excludeIdNum = Number(excludeRecId);
                const conflictRec = records.find(rec => 
                    (rec.status !== 'canceled') && 
                    rec.date === dateStr && 
                    rec.id != excludeIdNum
                );
                
                if(conflictRec) {
                    const conflictStudent = students.find(s => s.id == conflictRec.sid);
                    const name = conflictStudent ? conflictStudent.name : "æœªçŸ¥å­¸ç”Ÿ";
                    
                    let statusText = "é å®š";
                    if(conflictRec.status === 'done') statusText = "å·²å®Œæˆ";
                    if(conflictRec.status === 'leave') statusText = "è«‹å‡";
                    if(conflictRec.status === 'rescheduled') statusText = "æ”¹æœŸ";

                    return `[${dateStr} ${name} (${statusText})]`;
                }
                return null;
            } catch(e) {
                console.error("æª¢æŸ¥è¡çªæ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                return null; 
            }
        }

        // === UI Functions ===
        function createRecordCard(r) {
            const div = document.createElement('div');
            const isRescheduled = r.status === 'rescheduled';
            
            let statusClass = "status-planned";
            if (r.status === 'done') statusClass = "status-done";
            if (r.status === 'leave') statusClass = "status-leave";
            if (r.status === 'rescheduled') statusClass = "status-rescheduled";
            if (r.status === 'canceled') statusClass = "status-leave";

            div.className = `record-card shadow-sm rounded-2xl mb-4 p-4 border border-gray-100 relative ${statusClass}`;
            
            if(r.type === 'renew') {
                div.style.borderLeftColor = '#6366f1'; 
                div.innerHTML = `<div class="flex justify-between font-bold text-indigo-800"><span><i class="fa-solid fa-receipt"></i> è³¼è²·ç´€éŒ„</span><span>+${r.amount}</span></div><div class="text-right text-xs text-indigo-400 mt-1">${r.date}</div>`;
            } else {
                const datePart = r.date.split(' ');
                const isPlanned = r.status === 'planned' || r.status === 'rescheduled';
                const canUpload = isPlanned || r.status === 'done';

                const imgsHtml = `<div class="img-scroller mt-3 mb-2 flex items-center gap-2">
                    ${canUpload ? `<div class="img-add-btn" onclick="document.getElementById('hiddenFile_${r.id}').click()"><i class="fa-solid fa-plus fa-lg"></i><input type="file" id="hiddenFile_${r.id}" class="hidden" accept="image/*" multiple onchange="window.handleDirectUpload(${r.id}, this)"></div>` : ''}
                    ${(r.imgs || []).map((src, idx)=>`<img src="${src}" class="img-thumb" onclick="window.openDirectPaint(${r.id}, ${idx})">`).join('')}
                </div>`;

                const noteHtml = `<textarea placeholder="èª²ç¨‹ç­†è¨˜..." class="w-full bg-transparent text-sm text-gray-700 resize-none outline-none border-b border-dashed border-gray-300 focus:border-indigo-400 pb-1 mb-2" onblur="window.updateNote(${r.id}, this.value)">${r.note || ''}</textarea>`;

                let actions = '';
                if(isPlanned) {
                    actions = `
                    <div class="flex justify-end mt-2 pt-2 border-t border-gray-100">
                        <button onclick="window.openSignModal(${r.id})" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700">ç°½åˆ°</button>
                    </div>`;
                } else if (r.status === 'done') {
                    const signTimeDisplay = r.signDate ? `<div class="text-[10px] text-gray-400 mt-1">âœï¸ ç°½ç½²æ–¼ï¼š${r.signDate.slice(5, 16)}</div>` : '';
                    actions = `<div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-start"><div><span class="text-xs font-bold text-green-600">âœ“ å·²å®Œæˆ</span>${signTimeDisplay}</div>${r.sig ? `<img src="${r.sig}" class="h-10 object-contain">` : ''}</div>`;
                } else if (r.status === 'leave') {
                    actions = `<div class="mt-2 pt-2 border-t border-gray-100"><span class="text-xs font-bold text-gray-400">è«‹å‡ (ä¸æ‰£å ‚)</span></div>`;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-lg text-gray-800">${datePart[0]} <span class="text-sm font-normal text-gray-500">${datePart[1]}</span></div>
                        <div class="flex items-center gap-1">
                            ${isRescheduled ? '<span class="text-[10px] bg-pink-100 text-pink-600 px-1 rounded">å·²æ”¹æœŸ</span>' : ''}
                            ${isPlanned ? `
                            <button onclick="window.openActionModal(${r.id})" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition active:bg-gray-200">
                                <i class="fa-solid fa-ellipsis-vertical text-lg"></i>
                            </button>` : ''}
                        </div>
                    </div>
                    ${noteHtml}
                    ${imgsHtml}
                    ${actions}
                `;
            }
            return div;
        }

        function openImageModal(src) {
            if(!src) return;
            document.getElementById('imageModalContent').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
        }
        function viewTempContract() { openImageModal(tempContractImg); }
        function viewContract() { const s = students.find(x => x.id == curSid); if(s && s.contractImg) openImageModal(s.contractImg); }
        function previewContractSetting() { openImageModal(appSettings.contractTemplate); }

        function backupData() {
            const dataToSave = { students, records, appSettings };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToSave));
            const downloadAnchorNode = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `tms_backup_${date}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            appSettings.lastBackup = date;
            saveData();
            checkBackupStatus();
            renderSettingsPage();
            alert("å‚™ä»½å·²ä¸‹è¼‰ï¼\nç´…è‰²è­¦å‘Šå·²è§£é™¤ã€‚");
        }

        function restoreData(input) {
            if(!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async event => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!data.students || !Array.isArray(data.students)) return alert("æ ¼å¼éŒ¯èª¤");
                    students = data.students;
                    records = data.records || [];
                    appSettings = data.appSettings || appSettings;
                    await saveData();
                    alert("é‚„åŸæˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                    location.reload();
                } catch (err) { alert("æª”æ¡ˆææ¯€"); }
            };
            reader.readAsText(file);
        }

        function checkBackupStatus() {
            const banner = document.getElementById('backupBanner');
            const dot = document.getElementById('settingsRedDot');
            const freq = parseInt(appSettings.freq || "7");

            if (freq === -1) {
                if(banner) banner.style.display = 'none';
                if(dot) dot.classList.add('hidden');
                return;
            }

            let isOverdue = false;
            let msg = '';

            if (!appSettings.lastBackup) {
                isOverdue = true;
                msg = `âš ï¸ ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªå‚™ä»½ï¼Œå»ºè­°ç«‹å³ä¸‹è¼‰å‚™ä»½æª”æ¡ˆï¼`;
            } else {
                const diff = (new Date() - new Date(appSettings.lastBackup)) / (1000 * 60 * 60 * 24);
                if (diff > freq) {
                    isOverdue = true;
                    msg = `âš ï¸ æ‚¨å·²è¶…é ${freq} å¤©æœªå‚™ä»½ï¼Œå»ºè­°ç«‹å³å‰å¾€è¨­å®šé ã€Œä¸‹è¼‰å‚™ä»½ã€ï¼`;
                }
            }

            if (isOverdue) {
                if(banner) { banner.innerHTML = msg; banner.style.display = 'block'; }
                if(dot) dot.classList.remove('hidden');
            } else {
                if(banner) banner.style.display = 'none';
                if(dot) dot.classList.add('hidden');
            }
        }

        function toggleCreateTrial(el) {
            const isTrial = el.checked;
            document.getElementById('cCredits').value = isTrial ? 1 : '';
            document.getElementById('cCredits').disabled = isTrial;
            document.getElementById('cCredits').classList.toggle('bg-gray-100', isTrial);
            document.getElementById('cTrialSetup').classList.toggle('hidden', !isTrial);
            document.getElementById('cRegularSetup').classList.toggle('hidden', isTrial);
            document.getElementById('cContractSection').classList.toggle('hidden', isTrial);
        }

        function openContractSigner(mode) {
            paintMode = 'contract';
            tempContractImg = null;
            const src = appSettings.contractTemplate;
            document.getElementById('paintModal').classList.remove('hidden'); 
            requestAnimationFrame(() => setupPaintScene(src, "åˆç´„ç°½ç½²")); 
        }

        async function saveContractTemplate(input) {
            if(input.files && input.files[0]) {
                appSettings.contractTemplate = await compressImage(await fileToDataURL(input.files[0]), 600, 0.3);
                document.getElementById('sysContractPreview').src = appSettings.contractTemplate;
                document.getElementById('sysContractPreview').classList.remove('hidden');
                saveData();
            }
        }

        function createStudent() {
            const btn = document.getElementById('btnCreate');
            const name=document.getElementById('cName').value, body=document.getElementById('cBody').value;
            const isTrial = document.getElementById('cIsTrial').checked;
            let credits = parseInt(document.getElementById('cCredits').value);
            
            if(!name || !credits) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            
            let rule = { freq:1, slots:[], start: getFmtDate(new Date()) };
            if(isTrial) {
                const tDate = document.getElementById('cTrialDate').value;
                const tTime = document.getElementById('cTrialHour').value + ":" + document.getElementById('cTrialMin').value;
                if(!tDate) return alert("è«‹é¸æ“‡é«”é©—æ—¥æœŸ");
                rule.start = tDate;
            } else {
                if(createSlots.length === 0 || !document.getElementById('cRegStart').value) return alert("è«‹è¨­å®šä¸Šèª²æ™‚æ®µèˆ‡é–‹å§‹æ—¥æœŸ");
                rule = { freq: parseInt(document.getElementById('cRegFreq').value), slots: [...createSlots], start: document.getElementById('cRegStart').value };
            }

            btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...`;
            setTimeout(async () => {
                const newSid = Date.now();
                const contractImg = isTrial ? null : tempContractImg;
                students.push({ id: newSid, name, credits, body: body||"ç„¡", contractImg, rule, isArchived: false, isTrial: isTrial });
                
                if(isTrial) {
                    const tDate = document.getElementById('cTrialDate').value;
                    const tTime = document.getElementById('cTrialHour').value + ":" + document.getElementById('cTrialMin').value;
                    records.push({ id: Date.now()+1, sid: newSid, date: tDate + " " + tTime, status: 'planned', note: 'é«”é©—èª²', imgs: [], sig: null });
                } else {
                    let count = 0, currDate = new Date(rule.start + "T00:00:00"); 
                    const refMonday = new Date(currDate); refMonday.setDate(currDate.getDate() - (currDate.getDay()==0?6:currDate.getDay()-1)); 
                    let safety = 0;
                    while(count < credits && safety < 1000) {
                        safety++;
                        const diffDays = Math.floor((currDate - refMonday) / (86400000));
                        const weekIdx = Math.floor(diffDays / 7);
                        if(weekIdx % rule.freq === 0) { 
                            const daySlots = rule.slots.filter(slot => slot.day === currDate.getDay());
                            daySlots.forEach(slot => {
                                if(count < credits) { 
                                    const dateStr = getFmtDate(currDate) + " " + slot.time;
                                    if(!records.some(r=>r.sid===newSid && r.date === dateStr)) {
                                        records.push({ id: Date.now() + Math.random(), sid: newSid, date: dateStr, status: 'planned', note: '', imgs: [], sig: null });
                                        count++;
                                    }
                                }
                            });
                        }
                        currDate.setDate(currDate.getDate() + 1);
                    }
                }
                await saveData();
                document.getElementById('cName').value=''; document.getElementById('cCredits').value=''; document.getElementById('cBody').value=''; 
                document.getElementById('cIsTrial').checked = false; toggleCreateTrial(document.getElementById('cIsTrial'));
                createSlots = []; renderCreateSlots();
                tempContractImg = null;
                document.getElementById('cContractPreview').classList.add('hidden');
                btn.disabled = false; btn.innerHTML = `<span>å®Œæˆå»ºæª”</span>`;
                alert("âœ… æ–°å¢æˆåŠŸï¼");
                switchTab('page-list');
            }, 50);
        }

        function addCreateSlot() {
            const d = parseInt(document.getElementById('cSlotDay').value);
            const t = document.getElementById('cSlotHour').value + ":" + document.getElementById('cSlotMin').value;
            if(!createSlots.some(s => s.day === d && s.time === t)) { createSlots.push({day: d, time: t}); renderCreateSlots(); }
        }
        function removeCreateSlot(idx) { createSlots.splice(idx, 1); renderCreateSlots(); }
        function renderCreateSlots() {
            const c = document.getElementById('cSlotList'); c.innerHTML = '';
            const daysMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            createSlots.sort((a,b) => (a.day===0?7:a.day) - (b.day===0?7:b.day)).forEach((s, i) => {
                c.innerHTML += `<span class="inline-flex items-center bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold mr-1 mb-1">é€±${daysMap[s.day]} ${s.time} <button onclick="window.removeCreateSlot(${i})" class="ml-2 text-blue-400 hover:text-blue-900">Ã—</button></span>`;
            });
        }

        function switchTab(id) {
            ['page-create', 'page-list', 'page-detail', 'page-settings'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            ['nav-create', 'nav-list', 'nav-settings'].forEach(n => { document.getElementById(n).className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition relative"; });
            let activeId = id.replace('page', 'nav');
            if(id === 'page-detail') activeId = 'nav-list';
            document.getElementById(activeId).className = "px-4 py-2 rounded-md text-sm font-bold shadow bg-white text-indigo-600 transition relative";
            if (id === 'page-create') {
                curSid = null; createSlots = []; renderCreateSlots(); tempContractImg = null;
                document.getElementById('cContractPreview').classList.add('hidden');
            }
            if(id === 'page-list') { currentView = 'calendar'; renderList(); }
            if(id === 'page-detail') currentView = 'detail';
            if(id === 'page-settings') renderSettingsPage();
        }

        function renderList() {
            renderCalendar();
            const list = document.getElementById('studentListBody'); list.innerHTML = '';
            const sortedStudents = [...students].filter(s => s && !s.isArchived).sort((a, b) => {
                let valA, valB;

                if (currentSort.key === 'name') {
                    valA = a.name;
                    valB = b.name;
                } else if (currentSort.key === 'rule') {
                    // æŒ‰é »ç‡æ•¸å­—æ’åº
                    valA = a.rule?.freq || 99;
                    valB = b.rule?.freq || 99;
                } else if (currentSort.key === 'nextDate') {
                    // æ‰¾å‡ºè©²å­¸ç”Ÿæœ€è¿‘çš„ä¸€å ‚èª²æ—¥æœŸ
                    const nextA = records.filter(r => r.sid === a.id && (r.status === 'planned' || r.status === 'rescheduled')).sort((x, y) => x.date.localeCompare(y.date))[0];
                    const nextB = records.filter(r => r.sid === b.id && (r.status === 'planned' || r.status === 'rescheduled')).sort((x, y) => x.date.localeCompare(y.date))[0];
                    valA = nextA ? nextA.date : '9999-12-31';
                    valB = nextB ? nextB.date : '9999-12-31';
                }

                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });                                     
            const daysMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            sortedStudents.forEach(s => { 
                if(!s || s.isArchived) return;
                const trialTag = s.isTrial ? `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded ml-2 font-bold">ğŸŒ± é«”é©—</span>` : '';
                const nextRec = records.filter(r => r.sid===s.id && (r.status==='planned' || r.status==='rescheduled')).sort((a,b)=>a.date.localeCompare(b.date))[0];
                const nextStr = nextRec ? `<span class="text-blue-600 font-bold">${nextRec.date}</span>` : '<span class="text-gray-400 text-xs">ç„¡é æ’</span>';
                let ruleStr = '<span class="text-gray-400 text-xs">æœªè¨­å®š</span>';
                if(s.rule && s.rule.slots && s.rule.slots.length > 0) {
                    const freqText = s.rule.freq == 1 ? "æ¯é€±" : (s.rule.freq == 2 ? "éš”é€±" : "æ¯æœˆ");
                    const slotsText = s.rule.slots.map(sl => `é€±${daysMap[sl.day]} ${sl.time}`).join(', ');
                    ruleStr = `<span class="text-xs text-gray-600 bg-gray-100 p-1 rounded">${freqText} (${slotsText})</span>`;
                }
                list.innerHTML += `
                <div class="student-row">
                    <div class="row-info" onclick="window.openDetail('${s.id}')">
                        <div class="font-bold text-lg text-gray-800">${s.name} ${trialTag}</div>
                        <div class="text-sm">${ruleStr}</div>
                        <div class="text-sm">${nextStr}</div>
                        <div class="font-mono text-xl font-bold text-indigo-600 text-right">${s.credits}</div>
                    </div>
                    <div class="text-right text-gray-300 pr-2"><i class="fa-solid fa-chevron-right"></i></div>
                </div>`; 
            });
            const arcList = document.getElementById('archivedListBody'); arcList.innerHTML = ''; let hasArc = false;
            students.forEach(s => { if(s && s.isArchived) { hasArc = true; arcList.innerHTML += `<div class="student-row opacity-60"><div class="row-info cursor-default"><div class="font-bold">${s.name}</div><div>-</div><div>-</div><div class="text-right">${s.credits}</div></div><div class="row-action"><button onclick="event.stopPropagation(); window.openProfileModal('${s.id}')" class="text-gray-500 hover:text-indigo-600 p-2"><i class="fa-solid fa-ellipsis-vertical"></i></button></div></div>`; } });
            document.getElementById('noArchiveMsg').style.display = hasArc ? 'none' : 'block';
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; const weekEnd = addDays(currentWeekStart, 6); 
            document.getElementById('currentWeekRange').innerText = `${currentWeekStart.getMonth()+1}/${currentWeekStart.getDate()} ~ ${weekEnd.getMonth()+1}/${weekEnd.getDate()}`; 
            const today = new Date(); today.setHours(0,0,0,0); const isCur = today >= currentWeekStart && today <= weekEnd; 
            document.getElementById('currentWeekLabel').innerText = isCur ? "æœ¬é€±" : (currentWeekStart > today ? "æœªä¾†" : "éå»"); 
            const dayNames = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
            for(let i=0; i<7; i++) {
                const dayDate = addDays(currentWeekStart, i); const dayStr = getFmtDate(dayDate); 
                const col = document.createElement('div'); col.className = "p-2 min-h-[150px] border-r border-gray-100 last:border-0"; 
                const isToday = dayStr === getFmtDate(new Date()); 
                let holidayHtml = '';
                if(appSettings.holidays && appSettings.holidays[dayStr]) {
                    holidayHtml = `<div class="mb-1 text-[10px] text-red-500 font-bold bg-red-50 px-1 rounded border border-red-100 leading-tight">${appSettings.holidays[dayStr]}</div>`;
                }
                
                col.innerHTML = `<div class="text-xs font-bold ${isToday?'text-indigo-600 bg-indigo-50 rounded px-1': 'text-gray-400'} mb-2 uppercase text-center">${dayNames[i]} <span class="block text-lg ${holidayHtml?'text-red-500':''}">${dayDate.getDate()}</span></div>${holidayHtml}`;;
                
                if(Array.isArray(records)) {
                    const dayRecords = records.filter(r => r && r.date && r.date.startsWith(dayStr)).sort((a,b)=> a.date.localeCompare(b.date));
                    dayRecords.forEach(r => {
                        const s = students.find(x => x.id === r.sid); 
                        if(!s || s.isArchived) return;
                        const time = r.date.split(' ')[1].substring(0,5); 
                        let styleClass = "cal-planned"; 
                        if(r.status === 'rescheduled') styleClass = "cal-rescheduled"; 
                        if(r.status === 'done') styleClass = "cal-done"; 
                        if(r.status === 'leave') styleClass = "cal-leave";
                        if(r.status === 'canceled') styleClass = "cal-leave";
                        
                        const card = document.createElement('div'); card.className = `cal-card ${styleClass}`; 
                        card.innerHTML = `<div class="cal-time">${time}</div><div class="cal-name truncate">${s.name}</div><div class="card-menu-btn" onclick="event.stopPropagation(); window.openActionModal(${r.id})"><i class="fa-solid fa-ellipsis-vertical"></i></div>`;
                        card.onclick = (e) => { if(e.target.closest('.card-menu-btn')) return; openDetail(r.sid); };
                        card.oncontextmenu = (e) => { e.preventDefault(); openActionModal(r.id); };
                        col.appendChild(card);
                    });
                }
                grid.appendChild(col);
            }
        }

        function openDetail(sid) {
            curSid = Number(sid); const s = students.find(x => x.id == sid);
            if(!s) return alert("è³‡æ–™éŒ¯èª¤");
            document.getElementById('dName').innerText = s.name || 'æœªå‘½å'; 
            document.getElementById('dCredits').innerText = s.credits || 0; 
            document.getElementById('dBody').innerText = s.body || ''; 
            document.getElementById('dTrialTag').classList.toggle('hidden', !s.isTrial);
            if(!s.rule) s.rule = {freq:1, slots:[], start:''};
            const daysMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            if(s.rule && s.rule.slots && s.rule.slots.length > 0) {
                const slotsStr = s.rule.slots.map(sl => `é€±${daysMap[sl.day]} ${sl.time}`).join('ã€');
                const freqStr = s.rule.freq == 1 ? "æ¯é€±" : (s.rule.freq == 2 ? "éš”é€±" : "æ¯æœˆ");
                document.getElementById('dRuleDisplay').innerText = `${freqStr} (${slotsStr})`;
            } else { document.getElementById('dRuleDisplay').innerText = "å°šæœªè¨­å®šæ’èª²è¦å‰‡"; }
            const cArea = document.getElementById('dContractArea');
            if (cArea) {
                 if(s.contractImg) { cArea.innerHTML = `<img src="${s.contractImg}" class="w-full rounded border cursor-pointer" onclick="openImageModal('${s.contractImg}')">`; } 
                 else { cArea.innerHTML = `<div class="text-red-500 font-bold text-sm mb-2">âš ï¸ å°šæœªç°½ç½²æ­£å¼åˆç´„</div><button onclick="openContractSigner('profile')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow">âœï¸ ç«‹å³è£œç°½</button>`; }
            }
            renderTimeline(); switchTab('page-detail');
        }

        function renderTimeline() {
            const t = document.getElementById('timeline'); 
            const allRecs = records.filter(r => r.sid == curSid);
            const history = allRecs.filter(r => r.status !== 'planned' && r.status !== 'rescheduled').sort((a,b)=> b.date.localeCompare(a.date));
            const future = allRecs.filter(r => r.status === 'planned' || r.status === 'rescheduled').sort((a,b)=> a.date.localeCompare(b.date));
            t.innerHTML = '';
            if(future.length > 0) {
                t.innerHTML += `<div class="text-xs font-bold text-indigo-600 mb-2 uppercase">é å®šèª²ç¨‹</div>`;
                t.appendChild(createRecordCard(future[0]));
                if(future.length > 1) {
                    const hiddenCount = future.length - 1;
                    const details = document.createElement('details'); details.className = "group mb-6";
                    details.innerHTML = `<summary class="list-none text-xs font-bold text-gray-400 bg-gray-50 p-2 rounded text-center cursor-pointer hover:bg-gray-100">ğŸ”½ æŸ¥çœ‹æ›´å¤šé æ’ (${hiddenCount}å ‚)</summary>`;
                    const container = document.createElement('div'); container.className = "mt-2 space-y-2";
                    for(let i=1; i<future.length; i++) container.appendChild(createRecordCard(future[i]));
                    details.appendChild(container); t.appendChild(details);
                }
                t.innerHTML += `<div class="border-b my-4 border-gray-200"></div>`;
            }
            if(history.length > 0) {
                t.innerHTML += `<div class="text-xs font-bold text-gray-400 mb-2 uppercase">æ­·å²ç´€éŒ„</div>`;
                history.forEach(r => t.appendChild(createRecordCard(r)));
            }
        }

        // === 1. é–‹å•Ÿé¸å–® (åŠ å…¥é˜²å‘†ï¼šè‹¥å·²è«‹å‡å‰‡é–ä½æŒ‰éˆ•) ===
        function openActionModal(rid) {
            targetRecId = rid;
            const r = records.find(x => x.id === rid);
            if (!r) return;

            // 1. å–å¾— DOM å…ƒç´ 
            const hint = document.getElementById('actionStatusHint');
            const inputTime = document.getElementById('actionNewTime');
            const footerContainer = document.getElementById('actionModalFooter');

            // 2. æº–å‚™å‹•æ…‹å…§å®¹
            let footerHtml = '';
            let statusTextHint = '';

            if (r.status === 'leave') {
                // ã€å·²è«‹å‡ç‹€æ…‹ã€‘ï¼šæ”¹æœŸæŒ‰éˆ•åœç”¨ï¼Œé¡¯ç¤ºå–æ¶ˆè«‹å‡
                statusTextHint = `(æ­¤èª²ç¨‹ç‚ºã€Œå·²è«‹å‡ã€ç‹€æ…‹ï¼Œé»æ“Šä¸‹æ–¹å¯å–æ¶ˆè«‹å‡)`;
                footerHtml = `
                    <button id="btnActionReschedule" onclick="window.submitReschedule()" disabled class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow opacity-50 cursor-not-allowed transition">
                        <i class="fa-regular fa-calendar-check mr-1"></i> æ”¹æœŸ
                    </button>
                    <button onclick="window.undoLeave('${r.id}')" class="flex-1 py-3 bg-emerald-500 text-white font-bold rounded-xl shadow hover:bg-emerald-600 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rotate-left"></i> å–æ¶ˆè«‹å‡
                    </button>
                `;
            } else {
                // ã€æ­£å¸¸æˆ–å®Œæˆç‹€æ…‹ã€‘ï¼šé¡¯ç¤ºæ”¹æœŸèˆ‡è«‹å‡
                const isDone = r.status === 'done';
                statusTextHint = isDone ? `(æ­¤èª²ç¨‹ç‚ºã€Œå·²å®Œæˆã€ç‹€æ…‹ï¼Œç„¡æ³•æ›´å‹•)` : "";
                footerHtml = `
                    <button id="btnActionReschedule" onclick="window.submitReschedule()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow hover:bg-indigo-700 transition">
                        <i class="fa-regular fa-calendar-check mr-1"></i> æ”¹æœŸ
                    </button>
                    <button id="btnActionLeave" onclick="window.submitLeave()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl border border-gray-200 hover:bg-gray-200 transition">
                        <i class="fa-solid fa-mug-hot mr-1"></i> è«‹å‡
                    </button>
                `;
            }

            // ğŸŒŸ åŸ·è¡Œæ¸²æŸ“ï¼šä¸€æ¬¡æ€§å¡å…¥ Footer
            if (footerContainer) {
                footerContainer.innerHTML = footerHtml;
            }

            // 3. è¨­å®šæ™‚é–“å…§å®¹
            document.getElementById('actionCurrentTime').innerText = `ç›®å‰æ™‚é–“ï¼š${r.date}`;
            inputTime.value = r.date.replace(' ', 'T');

            // 4. é–å®šé‚è¼¯ (é‡å°å·²å®Œæˆ 'done' æˆ–å·²å–æ¶ˆ 'canceled' çš„è™•ç†)
            const isFullyLocked = (r.status === 'done' || r.status === 'canceled');
            // é‡æ–°å–å¾—æŒ‰éˆ•ç‰©ä»¶ (å› ç‚ºå‰›æ‰ innerHTML åˆ·æ–°äº†)
            const newBtnRes = document.getElementById('btnActionReschedule');
            const newBtnLea = document.getElementById('btnActionLeave');

            if (r.status === 'leave') {
                // ã€è«‹å‡ç‹€æ…‹ã€‘
                inputTime.disabled = true; // è«‹å‡æ™‚ä¸èƒ½æ”¹æ™‚é–“
                hint.innerText = statusTextHint;
                hint.className = "text-xs font-bold mb-2 text-emerald-600 text-center";
                
                // ç¢ºä¿ã€Œå›å¾©ä¸Šèª²ã€æŒ‰éˆ•æ˜¯å•Ÿç”¨çš„ï¼Œè€Œã€Œæ”¹æœŸã€æŒ‰éˆ•æ˜¯åœç”¨çš„
                const btnRes = document.getElementById('btnActionReschedule');
                if (btnRes) btnRes.disabled = true;
                // æ³¨æ„ï¼šå›å¾©ä¸Šèª²æŒ‰éˆ•æ²’æœ‰ idï¼Œæ‰€ä»¥ä¸æœƒè¢«èª¤é–
            } else if (isFullyLocked) {
                // ã€å®Œæˆæˆ–å–æ¶ˆç‹€æ…‹ã€‘
                inputTime.disabled = true;
                hint.innerText = statusTextHint;
                hint.className = "text-xs font-bold mb-2 text-red-500 text-center";
                
                // é–å®šæ‰€æœ‰æŒ‰éˆ•
                const btnRes = document.getElementById('btnActionReschedule');
                const btnLea = document.getElementById('btnActionLeave');
                if (btnRes) btnRes.disabled = true;
                if (btnLea) btnLea.disabled = true;
            } else {
                // ã€æ­£å¸¸ç‹€æ…‹ã€‘
                inputTime.disabled = false;
                hint.innerText = "";
                const btnRes = document.getElementById('btnActionReschedule');
                if (btnRes) btnRes.disabled = false;
            }

            document.getElementById('actionModal').classList.remove('hidden');
        }

        // === 2. æäº¤æ”¹æœŸ (åŠ å…¥é˜²å‘†) ===
        function submitReschedule() { 
            try { 
                const targetRecord = records.find(x => x.id == targetRecId); 
                if (!targetRecord) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹èª²ç¨‹è³‡æ–™"); 
                
                // --- ä¿®æ”¹é» Aï¼šæ”¾å¯¬é™åˆ¶ï¼Œå…è¨± 'leave' ç‹€æ…‹é€²è¡Œæ”¹æœŸ ---
                if (targetRecord.status !== 'planned' && targetRecord.status !== 'rescheduled' && targetRecord.status !== 'leave') {
                    return alert("âŒ æ­¤èª²ç¨‹ç‹€æ…‹ç„¡æ³•æ”¹æœŸ (å·²å®Œæˆæˆ–å·²å–æ¶ˆ)");
                }

                const val = document.getElementById('actionNewTime').value; 
                if(!val) return; 
                const newDate = val.replace('T', ' '); 
                
                const conflictMsg = checkConflict(newDate, targetRecord.id); 
                if (conflictMsg) { 
                    if (!confirm(`âš ï¸ æ’æœŸè­¦å‘Šï¼š\nè©²æ™‚æ®µå·²æœ‰ ${conflictMsg}ã€‚\n\nç¢ºå®šè¦å¼·åˆ¶æ”¹æœŸå—ï¼Ÿ`)) return; 
                } 

                // --- ä¿®æ”¹é» Bï¼šå¦‚æœåŸæœ¬æ˜¯è«‹å‡ç‹€æ…‹ï¼Œç¾åœ¨æ”¹æœŸä»£è¡¨è¦ä¸Šèª²ï¼Œéœ€ç§»é™¤æœ€å¾Œä¸€å ‚è£œèª² ---
                if (targetRecord.status === 'leave') {
                    removeLastPlannedRecord(targetRecord.sid, targetRecord.id);
                }
                
                targetRecord.date = newDate; 
                targetRecord.status = 'rescheduled'; 
                
                saveData(); 
                document.getElementById('actionModal').classList.add('hidden'); 
                if(currentView==='calendar') renderCalendar(); else renderTimeline(); 
            } catch (error) { 
                console.error(error); alert("ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤ï¼š" + error.message); 
            } 
        }

        // === 3. æäº¤è«‹å‡ (ä¿®æ­£é‚è¼¯ï¼šç¢ºèª -> è‡ªå‹•åˆ¤æ–· -> ç›´æ¥åŸ·è¡Œ) ===
        function submitLeave() {
            const targetRecord = records.find(x => x.id === targetRecId);
            if(!targetRecord) return;
            
            // é˜²å‘†ï¼šå†æ¬¡æª¢æŸ¥ç‹€æ…‹
            if(targetRecord.status === 'leave') return alert("æ­¤èª²ç¨‹å·²ç¶“æ˜¯è«‹å‡ç‹€æ…‹ï¼");

            // æ­¥é©Ÿ A: å…ˆç¢ºèªæ˜¯å¦çœŸçš„è¦è«‹å‡
            if(!confirm("ç¢ºå®šè¦å¹«é€™ä½å­¸ç”Ÿè«‹å‡å—ï¼Ÿ")) return;

            const s = students.find(x => x.id === targetRecord.sid);
            
            // æ¨™è¨˜ç‚ºè«‹å‡
            targetRecord.status = 'leave';
            let msg = "âœ… å·²æ¨™è¨˜ç‚ºè«‹å‡ (ä¸æ‰£å ‚)ã€‚";
            
            // æ­¥é©Ÿ B: åˆ¤æ–·æ˜¯å¦æœ‰è¦å‰‡ï¼Œæœ‰å‰‡ã€Œç›´æ¥è‡ªå‹•é †å»¶ã€ï¼Œä¸è·³è¦–çª—è©¢å•
            if(s && s.rule && s.rule.freq && s.rule.slots && s.rule.slots.length > 0) {
                // æ‰¾å‡ºè©²å­¸ç”Ÿæ‰€æœ‰ã€Œæœªä¾†æœ‰æ•ˆèª²ç¨‹ã€çš„æœ€å¾Œä¸€å¤©
                const futureRecs = records.filter(r => r.sid === s.id && (r.status === 'planned' || r.status === 'rescheduled')).sort((a,b) => a.date.localeCompare(b.date));
                
                let baseDateObj;
                if (futureRecs.length > 0) {
                    baseDateObj = new Date(futureRecs[futureRecs.length-1].date.split(' ')[0]);
                } else {
                    // å¦‚æœæ²’æœ‰æœªä¾†èª²ç¨‹ï¼Œå°±å¾ä»Šå¤©(è«‹å‡é€™å¤©)é–‹å§‹å¾€å¾Œç®—
                    baseDateObj = new Date(targetRecord.date.split(' ')[0]);
                }
                
                // è¨ˆç®—æ—¥æœŸï¼šæœ€å¾Œæ—¥æœŸ + (é »ç‡ * 7)
                const daysToAdd = parseInt(s.rule.freq) * 7;
                baseDateObj.setDate(baseDateObj.getDate() + daysToAdd);
                
                // ç”¢ç”Ÿæ–°æ—¥æœŸå­—ä¸²
                const timePart = targetRecord.date.split(' ')[1];
                const newDateStr = getFmtDate(baseDateObj) + " " + timePart; // getFmtDate éœ€è¦å­˜åœ¨æ–¼æ‚¨çš„ helper ä¸­
                
                // ç›´æ¥å¯«å…¥æ–°èª²ç¨‹
                records.push({ 
                    id: Date.now(), 
                    sid: s.id, 
                    date: newDateStr, 
                    status: 'planned', 
                    note: 'è‡ªå‹•é †å»¶è£œèª²', 
                    isAutoExtension: true, // âœ… æ–°å¢æ¨™è¨˜ï¼Œæ–¹ä¾¿å¾ŒçºŒç²¾æº–ç§»é™¤
                    imgs: [], 
                    sig: null 
                });
                
                msg += `\n\nğŸ”„ ç³»çµ±å·²æ ¹æ“šè¦å‰‡ï¼Œè‡ªå‹•é †å»¶ä¸€å ‚èª²è‡³ï¼š${newDateStr}`;
            } else {
                msg += "\n(å› ç„¡é•·æœŸæ’èª²è¦å‰‡ï¼Œæ•…æœªåŸ·è¡Œè‡ªå‹•é †å»¶)";
            }

            saveData();
            alert(msg);
            document.getElementById('actionModal').classList.add('hidden');
            if(currentView==='calendar') renderCalendar(); else renderTimeline();
        }

        // === ä¿®æ­£ï¼šè¨­å®šé é¢é¡¯ç¤ºå®¹é‡ ===
        function renderSettingsPage() {
            const timeSpan = document.getElementById('lastBackupTime'); if (timeSpan) timeSpan.innerText = appSettings.lastBackup ? appSettings.lastBackup : "å°šç„¡ç´€éŒ„";
            const freqSelect = document.getElementById('backupFreq'); if (freqSelect) freqSelect.value = appSettings.freq || "7";
            
            try {
                const jsonStr = JSON.stringify({students, records, appSettings});
                const bytes = new Blob([jsonStr]).size;
                const mbs = (bytes / 1024 / 1024).toFixed(2);
                document.getElementById('dbSizeDisplay').innerText = mbs + " MB";
            } catch(e) {
                document.getElementById('dbSizeDisplay').innerText = "æœªçŸ¥";
            }
            
            checkBackupStatus();
        }

        function saveSettings() { const freq = document.getElementById('backupFreq').value; appSettings.freq = freq; saveData(); checkBackupStatus(); }
        function emergencyReset(){if(confirm("âš ï¸ é‡ç½®å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")){ const req = indexedDB.deleteDatabase(DB_NAME); req.onsuccess = ()=>location.reload(); }}
        function addNewRecord() { const dateStr = prompt("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ™‚é–“ (YYYY-MM-DD HH:MM)", getFmtDate(new Date()) + " 10:00"); if(dateStr) { const conflictMsg = checkConflict(dateStr); if (conflictMsg && !confirm(`âš ï¸ æ’æœŸè­¦å‘Šï¼š\nè©²æ™‚æ®µå·²æœ‰ ${conflictMsg}ã€‚\n\nç¢ºå®šè¦å¼·åˆ¶æ’å…¥å—ï¼Ÿ`)) return; const s = students.find(x => x.id == curSid); records.push({ id: Date.now(), sid: curSid, date: dateStr, status: 'planned', note: '', imgs: [], sig: null }); saveData(); renderTimeline(); } }
        
        function saveProfile() {
            try {
                const s = students.find(x => x.id == curSid);
                if (!s) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²å­¸ç”Ÿè³‡æ–™");
                s.name = document.getElementById('pName').value;
                s.body = document.getElementById('pBody').value;
                s.isArchived = !document.getElementById('pArchivedToggle').checked;
                s.rule = { freq: parseInt(document.getElementById('ruleFreq').value), slots: [...(ruleSlots || [])], start: document.getElementById('ruleStartDate').value };
                saveData(); renderList(); if (curSid) openDetail(curSid); document.getElementById('profileModal').classList.add('hidden');
            } catch (e) { console.error(e); alert("å„²å­˜å¤±æ•—ï¼š" + e.message); }
        }
        
        function addDays(d, days) { const result = new Date(d); result.setDate(result.getDate() + days); return result; }
        function getTimeString() { return new Date().toLocaleString('zh-TW', { hour12: false }); }
        function fileToDataURL(f){return new Promise(r=>{if(!f)r(null);const d=new FileReader();d.onload=(e)=>r(e.target.result);d.readAsDataURL(f);});}
        function compressImage(src,w,q){ return new Promise(r=>{ if(!src)r(null); const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'); let rw=i.width,rh=i.height; if(rw>w){rh=Math.round(rh*=w/rw);rw=w;} c.width=rw;c.height=rh; const x=c.getContext('2d'); x.fillStyle="#ffffff"; x.fillRect(0,0,rw,rh); x.drawImage(i,0,0,rw,rh); r(c.toDataURL('image/jpeg',q)); }; i.src=src; }); }
        function initPad(id){const c=document.getElementById(id); if(!c) return; const p=c.parentElement; const rsz=()=>{const r=Math.max(window.devicePixelRatio||1,1),w=p.clientWidth||300,h=p.clientHeight||150; c.width=w*r;c.height=h*r;c.style.width=w+"px";c.style.height=h+"px";const x=c.getContext('2d');x.scale(r,r);x.lineCap='round';x.lineJoin='round'; if(id==='canvasPaint'){const b=document.getElementById('canvasBg');if(b){b.width=w*r;b.height=h*r;bgCanvasCtx=b.getContext('2d');bgCanvasCtx.scale(r,r);}}else{x.fillStyle='#fff';x.fillRect(0,0,c.width/r,c.height/r);} }; new ResizeObserver(rsz).observe(p); rsz(); let d=false;const x=c.getContext('2d'); const gp=(e)=>{const b=c.getBoundingClientRect();return{x:(e.touches?e.touches[0].clientX:e.clientX)-b.left,y:(e.touches?e.touches[0].clientY:e.clientY)-b.top}}; const st=(e)=>{if(e.cancelable)e.preventDefault();if(id==='canvasPaint')saveH();d=true;x.beginPath();const p=gp(e);x.moveTo(p.x,p.y);}; const mv=(e)=>{if(!d)return;if(e.cancelable)e.preventDefault();const p=gp(e);x.lineTo(p.x,p.y);if(id!=='canvasPaint'){x.strokeStyle='#1f2937';x.lineWidth=2;}x.stroke();}; const ed=()=>d=false; c.addEventListener('touchstart',st,{passive:false});c.addEventListener('touchmove',mv,{passive:false});c.addEventListener('touchend',ed);c.addEventListener('mousedown',st);c.addEventListener('mousemove',mv);c.addEventListener('mouseup',ed); pads[id]={c,ctx:x};}
        function saveH(){if(paintHistory.length>10)paintHistory.shift();paintHistory.push(pads['canvasPaint'].c.toDataURL());}
        function undoPaint(){const ctx = pads['canvasPaint'].ctx; const w = pads['canvasPaint'].c.width; const h = pads['canvasPaint'].c.height; if(paintHistory.length>0){const i=new Image();i.onload=()=>{ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.clearRect(0,0,w,h); ctx.drawImage(i,0,0); ctx.scale(Math.max(window.devicePixelRatio||1,1),Math.max(window.devicePixelRatio||1,1));};i.src=paintHistory.pop();}else{ctx.clearRect(0,0,w/(Math.max(window.devicePixelRatio||1,1)),h/(Math.max(window.devicePixelRatio||1,1)));}}
        function setupPaintScene(src, title){paintHistory=[];document.getElementById('paintModal').classList.remove('hidden');document.getElementById('paintTitle').innerText=title||"åœ–ç‰‡æ¨™è¨»";initPad('canvasPaint');pads['canvasPaint'].ctx.clearRect(0,0,pads['canvasPaint'].c.width,pads['canvasPaint'].c.height);if(src){const i=new Image();i.onload=()=>{drawImageFit(i,document.getElementById('canvasBg'),bgCanvasCtx);};i.src=src;} else { bgCanvasCtx.fillStyle='#fff'; bgCanvasCtx.fillRect(0,0,document.getElementById('canvasBg').width,document.getElementById('canvasBg').height); } setPen('#ef4444');}
        function savePaint(){ const b=document.getElementById('canvasBg'),p=document.getElementById('canvasPaint'),t=document.createElement('canvas');t.width=b.width;t.height=b.height;const x=t.getContext('2d');x.drawImage(b,0,0);x.drawImage(p,0,0); (async()=>{ const d=await compressImage(t.toDataURL(),800,0.5); if(paintMode === 'photo' && isDirectEdit){ const i=records.findIndex(r=>r.id===directEditRecId);if(i>-1){records[i].imgs[paintImgIndex]=d;saveData();renderTimeline();} } else if(paintMode === 'contract') { if(curSid) { const s=students.find(x=>x.id===curSid); s.contractImg = d; saveData(); openDetail(curSid); document.getElementById('pContractArea').innerHTML = `<img src="${d}" class="w-full rounded border mb-2"><button onclick="openContractSigner('profile')" class="text-xs text-gray-400 underline">é‡æ–°ç°½ç½²</button>`;} else { tempContractImg = d; document.getElementById('cContractThumb').src = d; document.getElementById('cContractPreview').classList.remove('hidden'); } } closePaintModal(); })(); }
        function closePaintModal(){document.getElementById('paintModal').classList.add('hidden');}
        function drawImageFit(img,c,ctx){const r=Math.min(c.width/window.devicePixelRatio/img.width,c.height/window.devicePixelRatio/img.height),w=img.width*r,h=img.height*r,x=(c.width/window.devicePixelRatio-w)/2,y=(c.height/window.devicePixelRatio-h)/2;ctx.clearRect(0,0,c.width,c.height);ctx.drawImage(img,0,0,img.width,img.height,x,y,w,h);}
        function setPen(c){const x=pads['canvasPaint'].ctx;x.globalCompositeOperation='source-over';x.strokeStyle=c;x.lineWidth=4;document.querySelectorAll('#paintModal button[id^="btn-"]').forEach(b=>b.classList.remove('ring-2','ring-white','ring-black'));if(c=='#ef4444')document.getElementById('btn-red').classList.add('ring-2','ring-white');if(c=='#000000')document.getElementById('btn-black').classList.add('ring-2','ring-white');if(c=='#ffffff')document.getElementById('btn-white').classList.add('ring-2','ring-black');}
        function setEraser(){const x=pads['canvasPaint'].ctx;x.globalCompositeOperation='destination-out';x.lineWidth=20;document.querySelectorAll('#paintModal button[id^="btn-"]').forEach(b=>b.classList.remove('ring-2','ring-white'));document.getElementById('btn-eraser').classList.add('ring-2','ring-black');}
        function handleDirectUpload(rid, input) { if(input.files) { Array.from(input.files).forEach(f=>{ const r = new FileReader(); r.onload = async(e)=>{ const d = await compressImage(e.target.result, 800, 0.5); const rec = records.find(x=>x.id===rid); if(rec) { if(!rec.imgs) rec.imgs=[]; rec.imgs.push(d); saveData(); renderTimeline(); } }; r.readAsDataURL(f); }); } }
        function updateNote(rid, val) { const r = records.find(x=>x.id===rid); if(r && r.note !== val) { r.note = val; saveData(); } }
        function openSignModal(rid) { signingRecId = rid; document.getElementById('signModal').classList.remove('hidden'); requestAnimationFrame(() => initPad('padSignModal')); }
        function openDirectPaint(rid,i){ directEditRecId=rid;paintImgIndex=i;isDirectEdit=true;paintMode='photo'; const r=records.find(x=>x.id===rid); if(r&&r.imgs[i]) { document.getElementById('paintModal').classList.remove('hidden'); requestAnimationFrame(() => setupPaintScene(r.imgs[i], "ç…§ç‰‡ç·¨è¼¯")); } }
        function toggleArchivedStatusInModal() { const toggle = document.getElementById('pArchivedToggle'); const status = document.getElementById('pArchivedStatus'); status.innerText = toggle.checked ? "å°å­˜" : "æ´»èº"; status.className = toggle.checked ? "text-xs font-bold text-gray-400 mb-1" : "text-xs font-bold text-green-600 mb-1"; }
        function deleteStudent(){if(confirm("âš ï¸ æ°¸ä¹…åˆªé™¤æ­¤å­¸ç”Ÿï¼Ÿ")){const i=students.findIndex(x=>x.id===curSid);if(i>-1){students.splice(i,1);records=records.filter(r=>r.sid!==curSid);saveData();document.getElementById('profileModal').classList.add('hidden');switchTab('page-list');}}}
        function submitRenew() { const amt = parseInt(document.getElementById('renewAmount').value); if(!amt) return alert("è«‹è¼¸å…¥å ‚æ•¸"); (async()=>{const sigStu = await compressImage(pads['padRenewStudent'].c.toDataURL(), 500, 0.5); const sigTea = await compressImage(pads['padRenewTeacher'].c.toDataURL(), 500, 0.5); const time = getTimeString(); const s = students.find(x=>x.id===curSid); s.credits += amt; if(s.isTrial) { s.isTrial = false; alert("ğŸ‰ æ­å–œï¼å­¸ç”Ÿå·²å¾é«”é©—è½‰ç‚ºæ­£å¼å­¸ç”Ÿï¼"); } records.unshift({ id: Date.now(), sid: curSid, date: time, type: 'renew', amount: amt, sigStudent: sigStu, sigTeacher: sigTea }); saveData(); document.getElementById('dCredits').innerText = s.credits; document.getElementById('dTrialTag').classList.add('hidden'); document.getElementById('renewAmount').value = ''; clearPad('padRenewStudent'); clearPad('padRenewTeacher'); closeRenewModal(); renderTimeline();})(); }
        function closeRenewModal() { document.getElementById('renewModal').classList.add('opacity-0'); document.getElementById('renewContent').classList.add('scale-95'); setTimeout(() => document.getElementById('renewModal').classList.add('hidden'), 200); }
        function openRenewModal() { const m = document.getElementById('renewModal'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); document.getElementById('renewContent').classList.remove('scale-95'); }, 10); setTimeout(() => { initPad('padRenewStudent'); initPad('padRenewTeacher'); }, 100); }
        function clearPad(id) { const p = pads[id]; if(!p) return; p.ctx.clearRect(0,0,p.c.width,p.c.height); p.ctx.fillStyle='#ffffff'; p.ctx.fillRect(0,0,p.c.width,p.c.height); }
        function closeSignModal() { document.getElementById('signModal').classList.add('hidden'); clearPad('padSignModal'); }
        async function confirmSignModal() { const idx = records.findIndex(r => r.id === signingRecId); if (idx > -1) { const s = students.find(x => x.id === curSid); const sig = await compressImage(pads['padSignModal'].c.toDataURL(), 400, 0.5); s.credits--; records[idx].status = 'done'; records[idx].sig = sig; records[idx].signDate = getTimeString(); saveData(); document.getElementById('dCredits').innerText = s.credits; renderTimeline(); closeSignModal(); alert("ç°½åˆ°æˆåŠŸï¼å·²æ‰£é™¤ 1 å ‚èª²"); } }
        function changeWeek(offset) { currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7)); renderCalendar(); }
        function addSlot() { const d = parseInt(document.getElementById('slotDay').value); const t = document.getElementById('slotHour').value + ":" + document.getElementById('slotMin').value; if(!ruleSlots.some(s => s.day === d && s.time === t)) { ruleSlots.push({day: d, time: t}); renderRuleSlots(); } }
        function removeSlot(idx) { ruleSlots.splice(idx, 1); renderRuleSlots(); }
        function renderRuleSlots() { const c = document.getElementById('slotList'); c.innerHTML = ''; const daysMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; ruleSlots.sort((a,b) => (a.day===0?7:a.day) - (b.day===0?7:b.day)).forEach((s, i) => { c.innerHTML += `<span class="inline-flex items-center bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold mr-1 mb-1">é€±${daysMap[s.day]} ${s.time} <button onclick="window.removeSlot(${i})" class="ml-2 text-indigo-400 hover:text-indigo-900">Ã—</button></span>`; }); }
        function openProfileModal(id) { if(id) curSid = Number(id); let s = students.find(x => x.id === curSid); if(!s) s = students.find(x => x.id == curSid); if(!s) return alert("è³‡æ–™éŒ¯èª¤"); try { document.getElementById('pName').value=s.name; document.getElementById('pBody').value=s.body; if(!s.rule) s.rule = {freq:1, slots:[], start:''}; ruleSlots=s.rule.slots ? [...s.rule.slots] : []; document.getElementById('ruleFreq').value=s.rule.freq || 1; document.getElementById('ruleStartDate').value=s.rule.start || getFmtDate(new Date()); renderRuleSlots(); const t=document.getElementById('pArchivedToggle'); t.checked=!s.isArchived; document.getElementById('pArchivedStatus').innerText=s.isArchived?"å°å­˜":"æ´»èº"; const cArea = document.getElementById('pContractArea'); if (cArea) { if(s.contractImg) { cArea.innerHTML = `<img src="${s.contractImg}" class="w-full rounded border mb-2"><button onclick="openContractSigner('profile')" class="text-xs text-gray-400 underline">é‡æ–°ç°½ç½²</button>`; } else { cArea.innerHTML = `<div class="text-red-500 font-bold text-xs mb-2">æœªç°½ç½²</div><button onclick="openContractSigner('profile')" class="bg-indigo-600 text-white px-3 py-2 rounded shadow text-xs">âœï¸ è£œç°½åˆç´„</button>`; } } document.getElementById('profileModal').classList.remove('hidden'); } catch(e) { console.error(e); } }
        function generateSchedule() { const s = students.find(x => x.id == curSid); const freq = parseInt(document.getElementById('ruleFreq').value); const startStr = document.getElementById('ruleStartDate').value; if(ruleSlots.length === 0 || !startStr) return alert("è«‹è¨­å®š"); if(s.credits <= 0) return alert("é¡åº¦ä¸è¶³"); const existing = records.filter(r => r.sid == curSid && (r.status === 'planned' || r.status === 'rescheduled') && r.date < startStr).length; const quota = s.credits - existing; if(quota <= 0) return alert("é¡åº¦å·²æ»¿"); let conflicts=0; let checkCount=0; let checkDate=new Date(startStr + "T00:00:00"); const checkMonday=new Date(checkDate); checkMonday.setDate(checkDate.getDate()-(checkDate.getDay()==0?6:checkDate.getDay()-1)); while(checkCount<quota && checkCount<100){ const diffDays=Math.floor((checkDate-checkMonday)/86400000); const wIdx=Math.floor(diffDays/7); if(wIdx%freq===0){ const slots=ruleSlots.filter(sl=>sl.day===checkDate.getDay()); slots.forEach(sl=>{ if(checkCount<quota){ if(checkConflict(getFmtDate(checkDate)+" "+sl.time)) conflicts++; checkCount++; } }); } checkDate.setDate(checkDate.getDate()+1); } if(conflicts>0 && !confirm(`æœ‰ ${conflicts} å ‚æ’æœŸï¼Œç¢ºå®šå¼·åˆ¶æ’å…¥ï¼Ÿ`)) return; records=records.filter(r=>!(r.sid==curSid && (r.status==='planned'||r.status==='rescheduled') && r.date>=startStr)); let count=0; let curr=new Date(startStr+"T00:00:00"); const ref=new Date(curr); ref.setDate(curr.getDate()-(curr.getDay()==0?6:curr.getDay()-1)); s.rule={freq,slots:[...ruleSlots],start:startStr}; while(count<quota){ const dDays=Math.floor((curr-ref)/86400000); const wI=Math.floor(dDays/7); if(wI%freq===0){ const sls=ruleSlots.filter(sl=>sl.day===curr.getDay()); sls.forEach(sl=>{ if(count<quota){ const dStr=getFmtDate(curr)+" "+sl.time; if(!records.some(r=>r.sid==curSid && r.date===dStr)){ records.push({id:Date.now()+Math.random(), sid:curSid, date:dStr, status:'planned', note:'', imgs:[], sig:null}); count++; } } }); } curr.setDate(curr.getDate()+1); } saveData(); alert(`å·²æ’ ${count} å ‚`); document.getElementById('profileModal').classList.add('hidden'); openDetail(curSid); }
        // === New Feature: Online Holidays ===
        async function updateOnlineHolidays() {
            if(!confirm("å³å°‡é€£ç·šè‡³ API (api.pin-yi.me) ä¸‹è¼‰æ˜å¹´å‡æ—¥ã€‚\n\nâš ï¸ è«‹ç¢ºå®šé›»è…¦å·²é€£ç¶²å†æŒ‰ç¢ºå®šï¼")) return;
            const nextYear = new Date().getFullYear() + 1;
            const url = `https://api.pin-yi.me/taiwan-calendar/${nextYear}/?isHoliday=true`;
            try {
                const res = await fetch(url);
                if(!res.ok) throw new Error("API é€£ç·šå¤±æ•—");
                const data = await res.json();
                let count = 0;
                if(Array.isArray(data)) {
                    data.forEach(item => {
                        // API format: 2025/01/01 -> We need: 2025-01-01
                        const dateStr = item.date.replace(/(\d{4})(\d{2})(\d{2})/, "$1-$2-$3"); 
                        // Some records use date_format
                        const finalDate = item.date_format ? item.date_format.replace(/\//g, '-') : dateStr;
                        const name = item.caption || item.description || "å‡æ—¥";
                        
                        if(!appSettings.holidays[finalDate]) {
                            appSettings.holidays[finalDate] = name;
                            count++;
                        }
                    });
                    saveData();
                    alert(`âœ… æ›´æ–°æˆåŠŸï¼æ–°å¢äº† ${count} ç­† ${nextYear} å¹´å‡æ—¥ã€‚`);
                    location.reload();
                }
            } catch(e) {
                alert("âŒ æ›´æ–°å¤±æ•—ï¼šç„¡æ³•é€£ç·šæˆ–è³‡æ–™åº«å°šæœªç™¼å¸ƒã€‚\néŒ¯èª¤ï¼š" + e.message);
            }
        }

        function importHolidays(input) {
            if(!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const newH = JSON.parse(e.target.result);
                    Object.assign(appSettings.holidays, newH);
                    saveData();
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                    location.reload();
                } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsText(input.files[0]);
        }
        function toggleSort(key) {
            if (currentSort.key === key) {
                currentSort.asc = !currentSort.asc; // å¦‚æœæŒ‰åŒä¸€å€‹ï¼Œå°±åˆ‡æ›æ­£ååº
            } else {
                currentSort.key = key;
                currentSort.asc = true;
            }
            renderList(); // é‡æ–°æ¸²æŸ“
        }
        function removeLastPlannedRecord(sid, currentRid) {
            // å„ªå…ˆæ‰¾æœ‰ 'isAutoExtension' æ¨™è¨˜çš„è£œèª²ï¼Œå¦‚æœæ²’æœ‰ï¼Œå°±æ‰¾æœ€å¾Œä¸€å ‚ planned èª²ç¨‹
            const studentPlannedRecs = records
                .filter(r => r.sid === sid && r.status === 'planned' && r.id !== currentRid)
                .sort((a, b) => b.date.localeCompare(a.date)); // æ—¥æœŸå¾æ™šåˆ°æ—©æ’åº

            if (studentPlannedRecs.length > 0) {
                // å„ªå…ˆåˆªé™¤å¸¶æœ‰æ¨™è¨˜çš„èª²ç¨‹ï¼Œè‹¥ç„¡å‰‡åˆªé™¤æœ€å¾Œä¸€å ‚
                const autoExtRec = studentPlannedRecs.find(r => r.isAutoExtension) || studentPlannedRecs[0];
                
                const idx = records.findIndex(r => r.id === autoExtRec.id);
                if (idx > -1) {
                    records.splice(idx, 1);
                    console.log("å·²è‡ªå‹•ç§»é™¤å› è«‹å‡ç”¢ç”Ÿçš„è£œèª²:", autoExtRec.date);
                }
            }
        }
        async function undoLeave(rid) {
            try {
                console.log("å˜—è©¦å›å¾©èª²ç¨‹:", rid);
                const targetRecord = records.find(x => x.id == rid); // æ³¨æ„é€™è£¡ç”¨ == é¿å…å‹åˆ¥å•é¡Œ
                if (!targetRecord) return alert("æ‰¾ä¸åˆ°èª²ç¨‹ç´€éŒ„");

                if (!confirm("ç¢ºå®šè¦å–æ¶ˆè«‹å‡ä¸¦å›å¾©ä¸Šèª²å—ï¼Ÿ\n(ç³»çµ±å°‡è‡ªå‹•ç§»é™¤æœ€å¾Œä¸€å ‚è£œèª²)")) return;

                // 1. åŸ·è¡Œç§»é™¤è£œèª²é‚è¼¯
                if (typeof window.removeLastPlannedRecord === 'function') {
                    window.removeLastPlannedRecord(targetRecord.sid, targetRecord.id);
                }

                // 2. ä¿®æ”¹ç‹€æ…‹
                targetRecord.status = 'planned';

                // 3. å„²å­˜
                if (typeof saveData === 'function') {
                    saveData();
                } else {
                    // å¦‚æœä½ æ˜¯ç”¨ç›´æ¥å¯«å…¥ DB çš„æ–¹å¼
                    await db.records.put(targetRecord);
                }

                // 4. é—œé–‰è¦–çª—èˆ‡åˆ·æ–°
                document.getElementById('actionModal').classList.add('hidden');
                if (currentView === 'calendar') renderCalendar(); else renderTimeline();
                
                console.log("å›å¾©æˆåŠŸ");
            } catch (error) {
                console.error("å›å¾©ä¸Šèª²ç™¼ç”ŸéŒ¯èª¤:", error);
                alert("å›å¾©å¤±æ•—ï¼ŒéŒ¯èª¤è³‡è¨Šè«‹è¦‹ Console");
            }
        }

        // BINDINGS
        window.changeWeek = changeWeek; window.openDetail = openDetail; window.toggleCreateTrial = toggleCreateTrial; window.addCreateSlot = addCreateSlot; window.removeCreateSlot = removeCreateSlot; window.addSlot = addSlot; window.removeSlot = removeSlot; window.createStudent = createStudent; window.openContractSigner = openContractSigner; window.saveContractTemplate = saveContractTemplate; window.backupData = backupData; window.restoreData = restoreData; window.emergencyReset = emergencyReset; window.closePaintModal = closePaintModal; window.undoPaint = undoPaint; window.savePaint = savePaint; window.setPen = setPen; window.setEraser = setEraser; window.closeRenewModal = closeRenewModal; window.submitRenew = submitRenew; window.openRenewModal = openRenewModal; window.clearPad = clearPad; window.closeSignModal = closeSignModal; window.confirmSignModal = confirmSignModal; window.openSignModal = openSignModal; window.openActionModal = openActionModal; window.submitReschedule = submitReschedule; window.submitLeave = submitLeave; window.openDirectPaint = openDirectPaint; window.openProfileModal = openProfileModal; window.saveProfile = saveProfile; window.deleteStudent = deleteStudent; window.generateSchedule = generateSchedule; window.handleDirectUpload = handleDirectUpload; window.updateNote = updateNote; window.toggleArchivedStatusInModal = toggleArchivedStatusInModal; window.addNewRecord = addNewRecord; window.saveSettings = saveSettings; window.viewTempContract = viewTempContract; window.previewContractSetting = previewContractSetting;
        window.switchTab = switchTab; // ç¢ºä¿ switchTab æœ‰è¢«ç¶å®šï¼
        window.updateOnlineHolidays = updateOnlineHolidays;
        window.importHolidays = importHolidays;
        window.toggleSort = toggleSort;
        window.undoLeave = undoLeave;
        window.getFmtDate = getFmtDate;
    </script>
</body>
</html>

